var AssetAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getAsset=function(e,t,n){function i(i){t.call(n,i,e)}if(RES.hasRes(e)){var s=RES.getRes(e);s?i(s):RES.getResAsync(e,i,this)}else RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var BaseScene=function(e){function t(t){e.call(this),this.inited=!1,this.percentWidth=100,this.percentHeight=100,this.touchEnabled=!1,this.addEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.skinName=t}__extends(t,e);var n=(__define,t),i=n.prototype;return i.componentCreated=function(){this.removeEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.inited=!0},i.onEnable=function(){},i.onRemove=function(){},i.onDestroy=function(){},t}(eui.Component);egret.registerClass(BaseScene,"BaseScene");var BaseUI=function(e){function t(t){e.call(this),this.inited=!1,this.addEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.skinName=t}__extends(t,e);var n=(__define,t),i=n.prototype;return i.componentCreated=function(){this.removeEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.inited=!0},t}(eui.Component);egret.registerClass(BaseUI,"BaseUI");var LayerManager=function(){function e(){this.tweenTime=500}var t=(__define,e),n=t.prototype;return n.initialize=function(e){this.main=e,this.sceneLayer=new eui.Group,this.sceneLayer.percentWidth=100,this.sceneLayer.percentHeight=100,this.main.addChild(this.sceneLayer),this.popLayer=new eui.Group,this.popLayer.percentWidth=100,this.popLayer.percentHeight=100,this.popLayer.touchEnabled=!1,this.popLayer.touchThrough=!0,this.main.addChild(this.popLayer)},n.runScene=function(e,t){void 0===t&&(t=!1),null!=this.curScene&&this.curScene&&(this.sceneLayer.removeChild(this.curScene),this.curScene.onRemove(),t&&this.curScene.onDestroy()),this.curScene=e,this.sceneLayer.addChild(e),e.inited&&e.onEnable()},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(LayerManager,"LayerManager");var LoadManager=function(){function e(){this.loadComplete=new Object,this.loadError=new Object,this.loadProgress=new Object,this.thisObject=new Object}var t=(__define,e),n=t.prototype;return e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},n.loadGroup=function(e,t,n,i,s){void 0===n&&(n=null),void 0===i&&(i=null),void 0===s&&(s=null),this.loadComplete[e]=n,this.loadError[e]=s,this.loadProgress[e]=i,this.thisObject[e]=t,RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup(e)},n.onResourceLoadComplete=function(e){var t=e.groupName;RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this);var n=this.loadComplete[t];null!=n&&n.call(this.thisObject[t],e),this.clearCallBack(t)},n.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load");var t=this.loadError[e.groupName];null!=t&&t.call(this.thisObject[e.groupName],e),this.clearCallBack(e.groupName)},n.onResourceProgress=function(e){var t=this.loadProgress[e.groupName];null!=t&&t.call(this.thisObject[e.groupName],e)},n.clearCallBack=function(e){this.loadComplete[e]=null,this.loadError[e]=null,this.loadProgress[e]=null},e}();egret.registerClass(LoadManager,"LoadManager");var GameConst=function(){function e(){}var t=(__define,e);t.prototype;return e.debug=!1,e}();egret.registerClass(GameConst,"GameConst");var GameManager=function(){function e(){this.homeScene=new HomeScene,this.gameScene=new GameScene}var t=(__define,e),n=t.prototype;return n.startup=function(e){GameConst.debug=window.gameConfig.debug,GameConst.stage=e.stage,LayerManager.getInstance().initialize(e),LayerManager.getInstance().runScene(this.homeScene),this.socket=ClientSocket.getInstance(),this.socket.gameManager=this,this.socket.homeScene=this.homeScene,this.socket.gameScene=this.gameScene,this.socket.startConnect()},n.connect=function(){this.homeScene.sendLogin()},n.disconnect=function(){},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(GameManager,"GameManager");var ClientSocket=function(){function e(){}var t=(__define,e),n=t.prototype;return e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},n.isConnected=function(){return this.socket&&this.socket.connected?!0:!1},n.closeSocket=function(){egret.log("主动断开连接"),this.socket.disconnect()},n.startConnect=function(){this.socket=io.connect(window.gameConfig.server,{reconnection:!1,"force new connection":!0});var e=this;this.socket.on("connect",function(){egret.log("connenct succss"),e.gameManager.connect()}),this.socket.on("error",function(e){egret.log("connenct erro")}),this.socket.on("disconnect",function(){egret.log("connenct close"),e.gameManager.disconnect()}),this.socket.on("reconnect_attempt",function(){egret.log("reconnect")}),this.socket.on("connect_timeout",function(){}),this.socket.on("startLock",function(t){e.homeScene.revStartLock()}),this.socket.on("startGame",function(t){e.gameScene.revStartGame()})},n.sendMessage=function(e,t,n,i){void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),this.socket&&this.socket.connected&&this.socket.emit(e,t,function(e){n&&i&&n.call(i,e)})},e}();egret.registerClass(ClientSocket,"ClientSocket");var GameScene=function(e){function t(){e.call(this,"GameSceneSkin"),this.deviceX=0,this.deviceZ=0,this.gestureUp=!1,this.gestureR=!1,this.gestureL=!1,this.angleLimit=45,this.angleReturn=30}__extends(t,e);var n=(__define,t),i=n.prototype;return i.componentCreated=function(){e.prototype.componentCreated.call(this),this.socket=ClientSocket.getInstance()},i.onEnable=function(){this.resetGame(),this.startGame()},i.onRemove=function(){},i.configListeners=function(){this.lockBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onLockBtnTouch,this)},i.deConfigListeners=function(){this.lockBtn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onLockBtnTouch,this)},i.startGame=function(){this.openDevice(),this.configListeners()},i.resetGame=function(){this.gestureUp=!1,this.gestureR=!1,this.gestureL=!1,this.centerZ=0,this.centerX=0,this.isLocked=!1},i.gameOver=function(){this.resetGame()},i.openDevice=function(){var e=new egret.DeviceOrientation;e.addEventListener(egret.Event.CHANGE,this.onOrientation,this),e.start()},i.onOrientation=function(e){if(this.deviceX=parseFloat(e.beta.toFixed(2)),this.deviceZ=parseFloat(e.alpha.toFixed(2)),this.deviceLabel.text="x轴角速度:"+this.deviceX+"\nz轴角速度:"+this.deviceZ,0!=this.isLocked&&(this.deviceLabel.text+="\naccX:"+this.deviceX.toFixed(2),this.deviceX>=this.angleLimit&&0==this.gestureUp?(this.gestureUp=!0,this.socket.sendMessage("action",{actionType:"up"}),egret.log("sendAction:up")):this.deviceX<=this.angleReturn&&(this.gestureUp=!1),!(this.deviceX>this.angleLimit))){var t=Math.round(this.deviceZ-this.centerZ);t<this.angleReturn&&t>-this.angleReturn&&(this.gestureR=!1,this.gestureL=!1),t>=this.angleLimit&&180>t||-180>t?0==this.gestureL&&0==this.gestureR&&(this.gestureL=!0,this.socket.sendMessage("action",{actionType:"left"}),egret.log("sendAction:left",this.deviceZ,"-",this.centerZ,"=",this.deviceZ-this.centerZ)):(t<=-this.angleLimit&&t>-180||t>180)&&0==this.gestureR&&0==this.gestureL&&(this.gestureR=!0,this.socket.sendMessage("action",{actionType:"right"}),egret.log("sendAction:14right",this.deviceZ,"-",this.centerZ,"=",this.deviceZ-this.centerZ))}},i.onLockBtnTouch=function(){egret.log("lock:",this.deviceZ),this.centerZ=this.deviceZ,this.centerX=this.deviceX,0==this.isLocked&&this.sendLock(),this.isLocked=!0},i.revStartGame=function(){egret.log("revStartGame"),this.startGame()},i.sendLock=function(){egret.log("sendLock"),this.socket.sendMessage("lock")},i.revGameOver=function(e){egret.log("revGameOver")},t}(BaseScene);egret.registerClass(GameScene,"GameScene");var HomeScene=function(e){function t(){e.call(this,"HomeSceneSkin")}__extends(t,e);var n=(__define,t),i=n.prototype;return i.componentCreated=function(){e.prototype.componentCreated.call(this),this.socket=ClientSocket.getInstance()},i.onEnable=function(){},i.onRemove=function(){},i.sendLogin=function(){var e=window.gameConfig.rid;egret.log("send login:",e,"userType:mobile"),this.socket.sendMessage("login",{rid:e,userType:"mobile"},this.revLogin,this)},i.revLogin=function(e){egret.log("rev login1");e.success,e.msg},i.revStartLock=function(){egret.log("revStartLock"),LayerManager.getInstance().runScene(GameManager.getInstance().gameScene)},t}(BaseScene);egret.registerClass(HomeScene,"HomeScene");var PreloadScene=function(e){function t(){e.call(this,"PreloadSceneSkin")}__extends(t,e);var n=(__define,t),i=n.prototype;return i.componentCreated=function(){e.prototype.componentCreated.call(this)},i.setProgress=function(e){this.inited&&(this.progressLabel.text=e.toString()+"%")},t}(BaseScene);egret.registerClass(PreloadScene,"PreloadScene");var Main=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var n=(__define,t),i=n.prototype;return i.createChildren=function(){e.prototype.createChildren.call(this);var t=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",t),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},i.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this)},i.onThemeLoadComplete=function(){LoadManager.getInstance().loadGroup("preload",this,this.onPreloadComplete)},i.onPreloadComplete=function(e){this.preloadScene=new PreloadScene,this.addChild(this.preloadScene),LoadManager.getInstance().loadGroup("game",this,this.onGameComplete,this.onGameProgress)},i.onGameProgress=function(e){this.preloadScene.setProgress(Math.round(e.itemsLoaded/e.itemsTotal*100))},i.onGameComplete=function(){this.removeChild(this.preloadScene),this.preloadScene=null,GameManager.getInstance().startup(this)},t}(eui.UILayer);egret.registerClass(Main,"Main");var ThemeAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getTheme=function(e,t,n,i){function s(e){t.call(i,e)}function o(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),n.call(i))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(e,s,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);