var ObjectPool=function(){function t(t){this.className=t,this.list=[]}var e=(__define,t);return p=e.prototype,p.getObject=function(){if(this.list.length>0)return this.list.shift();var t=egret.getDefinitionByName(this.className);return new t},p.returnObject=function(t){this.list.push(t)},t.getPool=function(e,i){if(void 0===i&&(i=0),!t.pool[e]&&(t.pool[e]=new t(e),0!=i))for(var s=egret.getDefinitionByName(e),h=t.pool[e],r=0;i>r;r++)h.returnObject(new s);return t.pool[e]},t.pool={},t}();egret.registerClass(ObjectPool,"ObjectPool");var SimpleButton=function(t){function e(e,i){void 0===i&&(i=null),t.call(this),this.up=new egret.Bitmap(RES.getRes(e)),this.addChild(this.up),null!=i&&(this.down=new egret.Bitmap(RES.getRes(i)),this.addChild(this.down),this.down.visible=!1),this.touchEnabled=!0,this.touchChildren=!1,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.touchBegin,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.touchBegin=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onPress()},p.touchEnd=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onRelease()},p.onPress=function(){this.down&&(this.up.visible=!1,this.down&&(this.down.visible=!0))},p.onRelease=function(){this.down&&(this.up.visible=!0,this.down&&(this.down.visible=!1))},p.setText=function(t){null==this.displayText&&null!=this.up&&(this.displayText=new egret.TextField,this.displayText.width=this.up.width,this.displayText.height=this.up.height,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.displayText.textColor=0,this.addChild(this.displayText)),this.displayText.text=t},p.setTextColor=function(t){this.displayText&&(this.displayText.textColor=t)},p.setTextSize=function(t){this.displayText&&(this.displayText.size=t)},e}(egret.Sprite);egret.registerClass(SimpleButton,"SimpleButton");var GameConst=function(){function t(){}var e=(__define,t);return p=e.prototype,t.totalScore=1e4,t.zheScore=[1e3,3e3,1e4],t.zheList=[9,8.5,8],t}();egret.registerClass(GameConst,"GameConst");var GameState;!function(t){t[t.Free=0]="Free",t[t.SelectRect=1]="SelectRect",t[t.WaitCancelRect=2]="WaitCancelRect",t[t.RefreshRect=3]="RefreshRect"}(GameState||(GameState={}));var RectColor;!function(t){t[t.Red=0]="Red",t[t.Blue=1]="Blue",t[t.Green=2]="Green"}(RectColor||(RectColor={}));var ZheUI=function(t){function e(){t.call(this),this.zhe0=new egret.Bitmap(RES.getRes("zhe0_png")),this.addChild(this.zhe0),this.zhe1=new egret.Bitmap(RES.getRes("zhe1_png")),this.addChild(this.zhe1),this.displayText=new egret.TextField,this.displayText.width=this.zhe0.width,this.displayText.height=this.zhe0.height,this.displayText.size=18,this.displayText.textColor=0,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.addChild(this.displayText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setZhe=function(t){this.zhe0.visible=!t,this.zhe1.visible=t},p.setText=function(t){this.displayText.text=t},e}(egret.Sprite);egret.registerClass(ZheUI,"ZheUI");var GameScene=function(t){function e(){t.call(this),this.rowMax=12,this.colMax=10,this.cellWidth=40,this.refreshList=[],this.score=0,this.picScale=1,this.refreshCount=0,this.levelupCount=0,this.initConfig(),this.initView()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.initConfig=function(){var t=RES.getRes("config_json");GameConst.zheScore=t.scoreList,GameConst.zheList=t.discountList,GameConst.reduceTime=t.reduceTime,GameConst.refreshTime=t.refreshTime,GameConst.levelUpTime=t.levelUpTime,GameConst.totalScore=t.scoreList[t.scoreList.length-1],this.rowMax=t.rowMax,this.colMax=t.colMax,this.picScale=t.picScale,this.cellWidth*=this.picScale},p.initView=function(){this._stage=GameConst.stage,this.rectPool=ObjectPool.getPool(Rect.NAME,this.rowMax*this.colMax),this.rectList=[];for(var t=0;t<this.rowMax;t++)this.rectList[t]=new Array;this.sceneBg=new egret.Bitmap(RES.getRes("bg_png")),this.sceneBg.width=this._stage.stageWidth,this.sceneBg.height=this._stage.stageHeight,this.addChild(this.sceneBg),this.scoreBarUI=new ScoreBarUI,this.scoreBarUI.x=(this._stage.stageWidth-this.scoreBarUI.scoreBg.width)/2,this.scoreBarUI.y=this._stage.stageHeight/20,this.addChild(this.scoreBarUI),this.gameBg=new egret.Bitmap(RES.getRes("gamebg_png")),this.gameBg.x=(this._stage.stageWidth-this.gameBg.width)/2,this.gameBg.y=this._stage.stageHeight/5.5,this.addChild(this.gameBg),this.startX=this.gameBg.x+(this.gameBg.width-this.cellWidth*this.colMax)/2,this.startY=this.gameBg.y-8+this.gameBg.height-this.cellWidth*this.rowMax,this.refreshBg=new egret.Bitmap(RES.getRes("refreshbg_png")),this.refreshBg.x=this.gameBg.x,this.refreshBg.y=this.gameBg.y+this.gameBg.height,this.addChild(this.refreshBg),this.refreshMask=new egret.Bitmap(RES.getRes("refreshmask_png")),this.refreshMask.x=this.refreshBg.x+2.5,this.refreshMask.y=this.refreshBg.y+2.5,this.addChild(this.refreshMask),this.startBtn=new egret.Bitmap(RES.getRes("start_png")),this.startBtn.x=(this._stage.stageWidth-this.startBtn.width)/2,this.startBtn.y=(this._stage.stageHeight-this.startBtn.height)/2,this.startBtn.touchEnabled=!0,this.addChild(this.startBtn),this.resultPanel=new ResultPanel,this.startBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startGame,this)},p.startGame=function(){this.removeChild(this.startBtn),this.createRect(),this.createRefreshRect(),this.startTimer(),this.changeState(1),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTap,this)},p.resetGame=function(){},p.gameOver=function(){this.stopTimer(),this.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTap,this),this.showResult()},p.changeState=function(t){this.curGameState=t},p.createRect=function(){for(var t,e,i=4;i<this.rowMax;i++)for(var s=0;s<this.colMax;s++)t=Math.floor(3*Math.random()),e=this.rectPool.getObject(),e.scaleX=this.picScale,e.scaleY=this.picScale,e.changeColor(t),e.row=i,e.col=s,e.isSelected=!1,e.x=this.startX+this.cellWidth*s,e.y=this.startY+this.cellWidth*i,this.addChild(e),this.rectList[i][s]=e},p.createRefreshRect=function(){for(var t,e,i=0;i<this.colMax;i++)t=Math.floor(3*Math.random()),e=this.rectPool.getObject(),e.scaleX=this.picScale,e.scaleY=this.picScale,e.changeColor(t),e.row=this.rowMax-1,e.col=i,e.isSelected=!1,e.x=this.refreshMask.x+this.cellWidth*i,e.y=this.refreshMask.y,this.addChild(e),this.refreshList[i]=e;this.addChild(this.refreshMask)},p.refreshRect=function(){for(var t,e=0;e<this.colMax;e++)if(null!=this.rectList[0][e])return void this.gameOver();for(e=1;e<this.rowMax;e++)for(var i=0;i<this.colMax;i++)t=this.rectList[e][i],t&&(t.row-=1,this.rectList[e-1][i]=t);for(e=0;e<this.colMax;e++)this.rectList[this.rowMax-1][e]=this.refreshList[e];this.refreshList.length=0,this.moveRect()},p.onTouchTap=function(t){t.target instanceof Rect&&this.checkRect(t.target)},p.checkRect=function(t){if(1==this.curGameState){this.changeState(2);var e,i,s,h=t.color,r=[],n=[];for(n.push(t),t.isSelected=!0;n.length>0;)e=n[0].row,i=n[0].col,this.checkLine(e-1,i,h,n),this.checkLine(e+1,i,h,n),this.checkLine(e,i-1,h,n),this.checkLine(e,i+1,h,n),s=n.shift(),r.push(s);if(r.length>2)this.cancelTile(r);else{for(var o=0;o<r.length;o++)r[o].isSelected=!1;this.changeState(1)}}},p.checkLine=function(t,e,i,s){if(t>=0&&t<this.rowMax&&e>=0&&e<this.colMax){var h=this.rectList[t][e];null!=h&&0==h.isSelected&&h.color==i&&(h.isSelected=!0,s.push(h))}},p.cancelTile=function(t){var e,i,s,h=t.length;this.score+=10*h+20+10*(h-3),this.scoreBarUI.setScore(this.score);for(var r=0;h>r;r++)e=t[r],i=e.row,s=e.col,this.rectList[i][s]=null,e.row=-1,e.col=-1,this.rectPool.returnObject(e),this.removeChild(e);t.length=0;for(var r=this.rowMax-2;r>=0;r--)for(var n=0;n<this.colMax;n++)if(e=this.rectList[r][n],null!=e){for(var o=r+1;o<this.rowMax;o++)null==this.rectList[o][n]&&(e.row+=1);this.rectList[r][n]=null,this.rectList[e.row][e.col]=e}for(var a=this.colMax/2,r=this.colMax-2;r>=a;r--){for(var n=0;n<this.rowMax&&(e=this.rectList[n][r],null==e);n++);if(n==this.rowMax)for(var o=0;o<this.rowMax;o++)for(var c=r+1;c<this.colMax;c++)e=this.rectList[o][c],null!=e&&(e.col-=1,this.rectList[o][c]=null,this.rectList[e.row][e.col]=e)}for(var r=1;a>r;r++){for(var n=0;n<this.rowMax&&(e=this.rectList[n][r],null==e);n++);if(n==this.rowMax)for(var o=0;o<this.rowMax;o++)for(var c=r-1;c>=0;c--)e=this.rectList[o][c],null!=e&&(e.col+=1,this.rectList[o][c]=null,this.rectList[e.row][e.col]=e)}this.moveRect()},p.moveRect=function(){for(var t,e,i,s,h,r=0;r<this.rowMax;r++)for(var n=0;n<this.colMax;n++)t=this.rectList[r][n],null!=t&&(e=t.row,i=t.col,s=this.startX+this.cellWidth*i,h=this.startY+this.cellWidth*e,egret.Tween.get(t).to({x:s,y:h},200,egret.Ease.backIn));var o=this;egret.Tween.get(this).wait(200).call(function(){3==o.curGameState&&o.createRefreshRect(),o.changeState(1)})},p.startTimer=function(){null==this.gameTimer&&(this.gameTimer=new egret.Timer(20)),this.gameTimer.addEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.gameTimer.reset(),this.gameTimer.start()},p.onTimerHandler=function(){this.refreshCount+=.02,this.levelupCount+=.02,this.refreshCount>=GameConst.refreshTime/50&&(this.refreshCount=0,this.refreshMask.scaleY-=.02,this.refreshMask.scaleY<=0&&(this.changeState(3),this.refreshMask.scaleY=1,this.refreshRect())),this.levelupCount>=GameConst.levelUpTime&&(this.levelupCount=0,GameConst.refreshTime-=GameConst.reduceTime,GameConst.refreshTime<0&&(GameConst.refreshTime=0))},p.stopTimer=function(){null!=this.gameTimer&&(this.gameTimer.stop(),this.gameTimer.removeEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this))},p.showResult=function(){this.resultPanel.show(this);var t=this.scoreBarUI.curZhe,e="";0>=t?e+="很遗憾，未获得折扣":(e+="获得:"+t+"折",e+="\n￥1000   -￥"+Math.round(1e3*(1-t/10))),e+="\n获得天天币:100",this.resultPanel.setText(e)},e}(egret.DisplayObjectContainer);egret.registerClass(GameScene,"GameScene");var LoadUI=function(t){function e(){t.call(this),this.loadText=new egret.TextField,this.loadText.textAlign=egret.HorizontalAlign.CENTER,this.loadText.width=100,this.loadText.textColor=0,this.addChild(this.loadText),this.x=GameConst.stage.stageWidth/2-this.loadText.width/2,this.y=GameConst.stage.stageHeight/2}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setLoadText=function(t){this.loadText.text=t},e}(egret.DisplayObjectContainer);egret.registerClass(LoadUI,"LoadUI");var Rect=function(t){function e(){t.call(this),this.isSelected=!1,this.touchEnabled=!0}__extends(e,t);var i=(__define,e);return p=i.prototype,p.changeColor=function(t){switch(t){case 0:this.texture=RES.getRes("red_png");break;case 1:this.texture=RES.getRes("blue_png");break;case 2:this.texture=RES.getRes("green_png");break;default:return void console.log("RectUI颜色不正确")}this.color=t},e.NAME="Rect",e}(egret.Bitmap);egret.registerClass(Rect,"Rect");var ResultPanel=function(t){function e(){t.call(this),this.bg=new egret.Bitmap(RES.getRes("resultbg_png")),this.addChild(this.bg),this.fxBtn=new SimpleButton("resultbtn_png"),this.fxBtn.setText("分享立减"),this.fxBtn.setTextSize(20),this.fxBtn.x=30,this.fxBtn.y=180,this.addChild(this.fxBtn),this.buyBtn=new SimpleButton("resultbtn_png"),this.buyBtn.setText("立刻购买"),this.buyBtn.setTextSize(20),this.buyBtn.x=180,this.buyBtn.y=180,this.addChild(this.buyBtn),this.contentText=new egret.TextField,this.contentText.width=this.bg.width,this.contentText.height=this.bg.height-this.fxBtn.height,this.contentText.textAlign=egret.HorizontalAlign.CENTER,this.contentText.verticalAlign=egret.VerticalAlign.MIDDLE,this.contentText.text="",this.contentText.textColor=0,this.addChild(this.contentText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.show=function(t){t.addChild(this),this.x=(GameConst.stage.stageWidth-this.bg.width)/2,this.y=(GameConst.stage.stageHeight-this.bg.height)/2,this.fxBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onFxBtnTouch,this),this.buyBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBuyBtnTouch,this)},p.onFxBtnTouch=function(){window.share()},p.onBuyBtnTouch=function(){window.toBuy()},p.setText=function(t){this.contentText.text=t},p.hide=function(){this.parent&&this.parent.removeChild(this)},e}(egret.Sprite);egret.registerClass(ResultPanel,"ResultPanel");var ScoreBarUI=function(t){function e(){t.call(this),this.zheScore=[],this.zheList=[],this.zheUIList=[],this.curZhe=0,this.zheScore=GameConst.zheScore,this.zheList=GameConst.zheList,this.scoreBg=new egret.Bitmap(RES.getRes("scorebg_png")),this.addChild(this.scoreBg),this.scoreBar=new egret.Bitmap(RES.getRes("scorebar_png")),this.scoreBar.x=this.scoreBg.x+1,this.scoreBar.y=this.scoreBg.y+1,this.addChild(this.scoreBar),this.scoreText=new egret.TextField,this.scoreText.width=70,this.scoreText.height=this.scoreBar.height,this.scoreText.textAlign=egret.HorizontalAlign.CENTER,this.scoreText.verticalAlign=egret.VerticalAlign.MIDDLE,this.scoreText.x=this.scoreBar.x,this.scoreText.y=this.scoreBar.y,this.addChild(this.scoreText);for(var e=this.zheList.length,i=0;e>i;i++){var s=new ZheUI;s.setText(this.zheList[i]+"折"),s.anchorOffsetX=s.width/2,s.x=this.scoreBg.x+this.zheScore[i]/GameConst.totalScore*this.scoreBar.width,s.y=this.scoreBg.y+this.scoreBg.height,s.setZhe(!1),this.addChild(s),this.zheUIList.push(s)}this.setScore(0)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setScore=function(t){this.scoreText.text=t.toString();var e=t/GameConst.totalScore;e>1&&(e=1),this.scoreBar.scaleX=e;for(var i=this.zheScore.length,s=-1,h=0;i>h;h++)t>=this.zheScore[h]&&(s=h,this.curZhe=this.zheList[s]);if(-1!=s){for(h=0;i>h;h++)this.zheUIList[h].setZhe(!1);this.zheUIList[s].setZhe(!0)}},e}(egret.DisplayObjectContainer);egret.registerClass(ScoreBarUI,"ScoreBarUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.onAddToStage=function(){GameConst.stage=this.stage,this.loadUI=new LoadUI,this.addChild(this.loadUI),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},p.onConfigComplete=function(){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},p.onResourceLoadComplete=function(){RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.createGameScene()},p.onResourceProgress=function(t){this.loadUI.setLoadText(t.itemsLoaded+"/"+t.itemsTotal)},p.createGameScene=function(){this.removeChild(this.loadUI);var t=new GameScene;this.addChild(t)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");