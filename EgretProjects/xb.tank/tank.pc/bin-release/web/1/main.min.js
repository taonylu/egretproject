var AssetAdapter=function(){function e(){}var t=(__define,e),i=t.prototype;return i.getAsset=function(e,t,i){function s(s){t.call(i,s,e)}if(RES.hasRes(e)){var n=RES.getRes(e);n?s(n):RES.getResAsync(e,s,this)}else RES.getResByUrl(e,s,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var GameFactory=function(){function e(){this.playerTankPool=ObjectPool.getPool(PlayerTank.NAME),this.normalTankPool=ObjectPool.getPool(NormalTank.NAME),this.fastTankPool=ObjectPool.getPool(FastTank.NAME),this.strongTankPool=ObjectPool.getPool(StrongTank.NAME),this.superTankPool=ObjectPool.getPool(SuperTank.NAME),this.tankList=new Array,this.itemPool=ObjectPool.getPool(BaseItem.NAME),this.bulletPool=ObjectPool.getPool(Bullet.NAME),this.boomPool=ObjectPool.getPool(Boom.NAME),this.tankBoomPool=ObjectPool.getPool(TankBoom.NAME),this.scoreLabelPool=ObjectPool.getPool(ScoreLabel.NAME),this.steelPool=ObjectPool.getPool(Steel.NAME),this.wallPool=ObjectPool.getPool(Wall.NAME),this.grassPool=ObjectPool.getPool(Grass.NAME),this.riverPool=ObjectPool.getPool(River.NAME),this.campPool=ObjectPool.getPool(Camp.NAME),this.tileList=[],this.flashPool=ObjectPool.getPool(Flash.NAME),this.tankList.push(this.playerTankPool),this.tankList.push(this.normalTankPool),this.tankList.push(this.fastTankPool),this.tankList.push(this.strongTankPool),this.tankList.push(this.superTankPool),this.tileList.push(this.grassPool),this.tileList.push(this.wallPool),this.tileList.push(this.steelPool),this.tileList.push(this.riverPool),this.tileList.push(this.campPool)}var t=(__define,e),i=t.prototype;return i.getFlash=function(){return this.flashPool.getObject()},i.getTank=function(e){return this.tankList[e].getObject()},i.getItem=function(e){var t=this.itemPool.getObject();return t.setType(e),t},i.getBullet=function(){return this.bulletPool.getObject()},i.getScoreLabel=function(){return this.scoreLabelPool.getObject()},i.getBoom=function(){return this.boomPool.getObject()},i.getTankBoom=function(){return this.tankBoomPool.getObject()},i.getTile=function(e){return this.tileList[e-1].getObject()},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(GameFactory,"GameFactory");var MapManager=function(){function e(){this.rowMax=13,this.colMax=13,this.tileWidth=64,this.tileHeight=64,this.halfWidth=32,this.halfHeight=32,this.levelLimit=0,this.curLevel=1,this.levelList=new Array,this.endLess_tankAdd=.3,this.endLess_superChance=50,this.endLess_superAdd=10,this.endless_itemNum=5}var t=(__define,e),i=t.prototype;return i.initalize=function(){this.levelList.length=0;var e=RES.getRes("map_json");if(null==e)return void alert("地图配置文件不存在");var t=e.level;this.levelLimit=t.levelLimit;for(var i=0;i<this.levelLimit;i++){var s=new LevelData;s.tankLimit=t.tankLimit[i],s.normalTank=t.normalTank[i],s.fastTank=t.fastTank[i],s.strongTank=t.strongTank[i],s.superTank=t.superTank[i],this.setTankList(s.tankList,TankEnum.normal,s.normalTank),this.setTankList(s.tankList,TankEnum.fast,s.fastTank),this.setTankList(s.tankList,TankEnum.strong,s.strongTank),this.setTankList(s.tankList,TankEnum["super"],s.superTank),ArrayTool.randomArr(s.tankList),s.itemNum=t.itemNum[i],s.shield=t.shield[i],s.gun=t.gun[i],s.star=t.star[i],s.armor=t.armor[i],s.life=t.life[i],s.boom=t.boom[i],s.pause=t.pause[i],s.initItemChance(),this.levelList[i]=s}this.tankSet=e.tankSet,this.itemSet=e.itemSet,this.playerSet=e.playerSet,this.endLess_tankAdd=t.tankAdd,this.endLess_superChance=t.superChance,this.endLess_superAdd=t.superAdd,this.endless_itemNum=t.itemNum[this.levelLimit-1];for(var i=1;i<=this.levelLimit;i++){var n=RES.getRes("level"+i+"_json");if(null==n)return void alert("第"+i+"关配置文件不存在");for(var a=n.layers[0].data,s=this.levelList[i-1],r=[],o=0;o<this.rowMax;o++){r[o]=[];for(var h=0;h<this.colMax;h++)r[o][h]=a[this.colMax*o+h]}s.mapData=r}},i.getCurLevelData=function(){return this.levelList[this.curLevel-1]},i.setTankList=function(e,t,i){for(var s=0;i>s;s++)e.push(t)},i.getEndLessLevelData=function(e){var t=this.levelList[this.levelLimit-1],i=Math.round(t.tankLimit*this.endLess_tankAdd*e),s=this.endLess_superChance+this.endLess_superAdd*e;t.tankList.length=0;for(var n=0;i>n;n++){var a=Math.random();if(s/2>a)t.tankList.push(TankEnum["super"]);else if(s>a)t.tankList.push(TankEnum.strong);else{var r=Math.random();.5>r?t.tankList.push(TankEnum.normal):t.tankList.push(TankEnum.fast)}}return t.itemNum=this.endless_itemNum,t},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(MapManager,"MapManager");var SoundManager=function(){function e(){this.start_stage="start_stage_mp3",this.lose="lose_mp3",this.gift_life="gift_life_mp3",this.gift_bomb="gift_bomb_mp3",this.gift="gift_mp3",this.fire_reach_wall="fire_reach_wall_mp3",this.fire="fire_mp3",this.user_move="user_move_mp3",this.soundList={},this.channelList={},this.addSound(this.start_stage),this.addSound(this.lose),this.addSound(this.gift_life),this.addSound(this.gift_bomb),this.addSound(this.gift),this.addSound(this.fire_reach_wall),this.addSound(this.fire),this.addSound(this.user_move)}var t=(__define,e),i=t.prototype;return i.addSound=function(e){this.soundList[e]=RES.getRes(e)},i.play=function(e,t,i){void 0===t&&(t=1),void 0===i&&(i=1);var s=this.soundList[e];s&&(this.channelList[e]=s.play(0,t),this.channelList[e].volume=i)},i.stop=function(e){var t=this.channelList[e];t&&t.stop()},i.playBgm=function(e,t){void 0===t&&(t=1),this.bgmChannel&&this.bgmChannel.stop();var i=this.soundList[e];i&&(this.bgmChannel=i.play(),this.bgmChannel.volume=t)},i.stopBgm=function(){this.bgmChannel&&(this.bgmChannel.stop(),this.bgmChannel=null)},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(SoundManager,"SoundManager");var UserManager=function(){function e(){this.userList=new Array,this.userLimit=2}var t=(__define,e),i=t.prototype;return i.addUser=function(e){if(this.userList.length<this.userLimit){if(0==this.isExsit(e.openid))return this.userList.push(e),!0}else console.log("用户数量已达上限");return!1},i.deleteUser=function(e){for(var t=this.userList.length,i=0;t>i;i++)this.userList[i].openid==e&&this.userList.splice(i,1)},i.getUser=function(e){for(var t=this.userList.length,i=0;t>i;i++)if(this.userList[i].openid==e)return this.userList[i];return null},i.isExsit=function(e){for(var t=this.userList.length,i=0;t>i;i++)if(this.userList[i].openid==e)return!0;return!1},i.isOverUserLimit=function(){return this.userList.length>this.userLimit?!0:!1},i.getUserNum=function(){return this.userList.length},i.clearAllUser=function(){this.userList.length=0},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(UserManager,"UserManager");var GameConst=function(){function e(){}var t=(__define,e);t.prototype;return e.historyScore=0,e.color7="#777777",e.color0="#000000",e.color2="#333A42",e}();egret.registerClass(GameConst,"GameConst");var GameStatus;!function(e){e[e.waiting=0]="waiting",e[e.gameing=1]="gameing",e[e.gameover=2]="gameover"}(GameStatus||(GameStatus={}));var TankEnum;!function(e){e[e.player=0]="player",e[e.normal=1]="normal",e[e.fast=2]="fast",e[e.strong=3]="strong",e[e["super"]=4]="super"}(TankEnum||(TankEnum={}));var ItemEnum;!function(e){e[e.shield=0]="shield",e[e.gun=1]="gun",e[e.star=2]="star",e[e.armor=3]="armor",e[e.life=4]="life",e[e.boom=5]="boom",e[e.pause=6]="pause"}(ItemEnum||(ItemEnum={}));var TileEnum;!function(e){e[e.grass=1]="grass",e[e.wall=2]="wall",e[e.steel=3]="steel",e[e.river=4]="river",e[e.camp=5]="camp"}(TileEnum||(TileEnum={}));var ActionEnum;!function(e){e[e.up=0]="up",e[e.down=1]="down",e[e.left=2]="left",e[e.right=3]="right",e[e.stopMove=4]="stopMove",e[e.stopShoot=5]="stopShoot",e[e.shoot=6]="shoot"}(ActionEnum||(ActionEnum={}));var DirectionEnum;!function(e){e[e.up=0]="up",e[e.down=1]="down",e[e.left=2]="left",e[e.right=3]="right"}(DirectionEnum||(DirectionEnum={}));var GameManager=function(){function e(){this.homeScene=new HomeScene,this.gameScene=new GameScene,this.resultScene=new ResultScene,this.transitionScene=new TransitionScene}var t=(__define,e),i=t.prototype;return i.startup=function(e){GameConst.gameConfig=window.gameConfig,GameConst.debug=GameConst.gameConfig.debug,GameConst.stage=e.stage,LayerManager.getInstance().initialize(e);var t=ClientSocket.getInstance();t.homeScene=this.homeScene,t.gameScene=this.gameScene,LayerManager.getInstance().runScene(this.homeScene)},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(GameManager,"GameManager");var LevelData=function(){function e(){this.mapData=[],this.normalTank=0,this.fastTank=0,this.strongTank=0,this.superTank=0,this.tankList=[],this.tankLimit=5,this.friendBirthPos=[[4,12],[8,12]],this.enemyBirthPos=[[0,0],[6,0],[12,0]],this.itemNum=0,this.shield=0,this.gun=0,this.star=0,this.armor=0,this.life=0,this.boom=0,this.pause=0}var t=(__define,e),i=t.prototype;return i.initItemChance=function(){this.gun+=this.shield,this.star+=this.gun,this.armor+=this.star,this.life+=this.armor,this.boom+=this.life,this.pause+=this.boom},i.getRandomItem=function(){var e=NumberTool.getRandomInt(0,100);return e<this.shield?ItemEnum.shield:e<this.gun?ItemEnum.gun:e<this.star?ItemEnum.star:e<this.armor?ItemEnum.armor:e<this.life?ItemEnum.life:e<this.boom?ItemEnum.boom:e<this.pause?ItemEnum.pause:ItemEnum.star},e}();egret.registerClass(LevelData,"LevelData");var UserVO=function(){function e(){this.openid="",this.headimgurl="",this.nickname=""}var t=(__define,e);t.prototype;return e}();egret.registerClass(UserVO,"UserVO");var ClientSocket=function(){function e(){}var t=(__define,e),i=t.prototype;return e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},i.isConnected=function(){return this.socket&&this.socket.connected?!0:!1},i.closeSocket=function(){egret.log("主动断开连接"),this.socket.disconnect()},i.startConnect=function(){this.socket=io.connect(GameConst.gameConfig.server,{reconnection:!1,"force new connection":!0});var e=this;this.socket.on("connect",function(){egret.log("connenct succss"),e.homeScene.connect()}),this.socket.on("error",function(e){egret.log("connenct erro"),alert("与服务器连接错误")}),this.socket.on("disconnect",function(){egret.log("connenct close"),alert("与服务器断开连接")}),this.socket.on("reconnect_attempt",function(){egret.log("reconnect")}),this.socket.on("connect_timeout",function(){egret.log("connect_timeout"),alert("连接超时")}),this.socket.on("login",function(t){e.homeScene.revLogin(t)}),this.socket.on("rank",function(t){e.homeScene.revRank(t)}),this.socket.on("userJoin",function(t){e.homeScene.revUserJoin(t)}),this.socket.on("userQuit",function(t){e.homeScene.revUserQuit(t)}),this.socket.on("action",function(t){e.gameScene.revAction(t)}),this.socket.on("gameOver",function(t){e.gameScene.revGameOver(t)})},i.sendMessage=function(e,t,i,s){void 0===t&&(t=null),void 0===i&&(i=null),void 0===s&&(s=null),this.socket&&this.socket.connected&&this.socket.emit(e,t,function(e){i&&s&&i.call(s,e)})},e}();egret.registerClass(ClientSocket,"ClientSocket");var LayerManager=function(){function e(){this.tweenTime=500}var t=(__define,e),i=t.prototype;return i.initialize=function(e){this.main=e,this.sceneLayer=new eui.Group,this.sceneLayer.percentWidth=100,this.sceneLayer.percentHeight=100,this.main.addChild(this.sceneLayer),this.popLayer=new eui.Group,this.popLayer.percentWidth=100,this.popLayer.percentHeight=100,this.popLayer.touchEnabled=!1,this.popLayer.touchThrough=!0,this.main.addChild(this.popLayer)},i.runScene=function(e,t){void 0===t&&(t=!1),null!=this.curScene&&this.curScene&&(this.sceneLayer.removeChild(this.curScene),this.curScene.onRemove(),t&&this.curScene.onDestroy()),this.curScene=e,this.sceneLayer.addChild(e),e.inited&&e.onEnable()},e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},e}();egret.registerClass(LayerManager,"LayerManager");var LoadManager=function(){function e(){this.loadComplete=new Object,this.loadError=new Object,this.loadProgress=new Object,this.thisObject=new Object}var t=(__define,e),i=t.prototype;return e.getInstance=function(){return null==this.instance&&(this.instance=new e),this.instance},i.loadGroup=function(e,t,i,s,n){void 0===i&&(i=null),void 0===s&&(s=null),void 0===n&&(n=null),this.loadComplete[e]=i,this.loadError[e]=n,this.loadProgress[e]=s,this.thisObject[e]=t,RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup(e)},i.onResourceLoadComplete=function(e){var t=e.groupName;RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this);var i=this.loadComplete[t];null!=i&&i.call(this.thisObject[t],e),this.clearCallBack(t)},i.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load");var t=this.loadError[e.groupName];null!=t&&t.call(this.thisObject[e.groupName],e),this.clearCallBack(e.groupName)},i.onResourceProgress=function(e){var t=this.loadProgress[e.groupName];null!=t&&t.call(this.thisObject[e.groupName],e)},i.clearCallBack=function(e){this.loadComplete[e]=null,this.loadError[e]=null,this.loadProgress[e]=null},e}();egret.registerClass(LoadManager,"LoadManager");var BaseScene=function(e){function t(t){e.call(this),this.inited=!1,this.percentWidth=100,this.percentHeight=100,this.touchEnabled=!1,this.addEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.skinName=t}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){this.removeEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.inited=!0},s.onEnable=function(){},s.onRemove=function(){},s.onDestroy=function(){},t}(eui.Component);egret.registerClass(BaseScene,"BaseScene");var BaseUI=function(e){function t(){e.call(this),this.inited=!1,this.addEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){this.removeEventListener(eui.UIEvent.CREATION_COMPLETE,this.componentCreated,this),this.inited=!0},t}(eui.Component);egret.registerClass(BaseUI,"BaseUI");var ArrayTool=function(){function e(){}var t=(__define,e);t.prototype;return e.randomArr=function(e){for(var t,i,s,n=e.length;n;)i=n-1,s=Math.floor(Math.random()*n),n--,i!=s&&(t=e[i],e[i]=e[s],e[s]=t)},e.random2DArr=function(t){for(var i=[],s=t.length,n=t[0].length,a=0;s>a;a++)for(var r=0;n>r;r++)i.push(t[a][r]);e.randomArr(i);for(var a=0;s>a;a++)for(var r=0;n>r;r++)t[a][r]=i[a*n+r]},e.copy2DArr=function(e){for(var t=new Array,i=e.length,s=e[0].length,n=0;i>n;n++){var a=new Array;t.push(a);for(var r=0;s>r;r++)a.push(e[n][r])}return t},e.getObjectLen=function(e){var t=0;for(var i in e)t++;return t},e}();egret.registerClass(ArrayTool,"ArrayTool");var HttpUtil=function(){function e(){this.httpMethod=egret.HttpMethod.GET,this.request=new egret.HttpRequest,this.request.responseType=egret.HttpResponseType.TEXT,this.request.addEventListener(egret.Event.COMPLETE,this.onPostComplete,this),this.request.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onPostIOError,this)}var t=(__define,e),i=t.prototype;return i.send=function(e,t,i){this.thisObject=i,this.request.open(e,this.httpMethod),this.request.setRequestHeader("Content-type","application/x-www-form-urlencoded"),""!=t?this.request.send(t):this.request.send()},i.onPostComplete=function(e){this.completeHandler&&this.completeHandler.call(this.thisObject,this.request.response)},i.onPostIOError=function(e){egret.log("http error"),this.errorHandler&&this.errorHandler.call(this.thisObject,e)},e}();egret.registerClass(HttpUtil,"HttpUtil");var NumberTool=function(){function e(){}var t=(__define,e);t.prototype;return e.getRandomInt=function(e,t){return Math.round(Math.random()*(t-e))+e},e.getVerificationCode=function(t){for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",s=i.length,n="",a=0;t>a;a++)n+=i.charAt(e.getRandomInt(0,s));return n},e}();egret.registerClass(NumberTool,"NumberTool");var ObjectPool=function(){function e(e){this.className=e,this.list=[]}var t=(__define,e),i=t.prototype;return i.getObject=function(){if(this.list.length>0)return this.list.shift();var e=egret.getDefinitionByName(this.className);return new e},i.returnObject=function(e){this.list.push(e)},e.getPool=function(t,i){if(void 0===i&&(i=0),!e.pool[t]&&(e.pool[t]=new e(t),0!=i))for(var s=egret.getDefinitionByName(t),n=e.pool[t],a=0;i>a;a++)n.returnObject(new s);return e.pool[t]},e.pool={},e}();egret.registerClass(ObjectPool,"ObjectPool");var QRCodeLoader=function(e){function t(){e.apply(this,arguments),this.logoUrl=""}__extends(t,e);var i=(__define,t),s=i.prototype;return s.load=function(e,t,i,s){void 0===s&&(s=""),this.qrcodeWidth=t,this.qrcodeHeight=i,this.logoUrl=s,null==this.imageLoader&&(this.imageLoader=new egret.ImageLoader,this.imageLoader.addEventListener(egret.Event.COMPLETE,this.onQRCodeComplete,this),this.imageLoader.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onQRCodeError,this)),this.imageLoader.load(e)},s.onQRCodeError=function(){console.log("加载二维码错误")},s.onQRCodeComplete=function(e){var t=new egret.Bitmap(this.imageLoader.data);t.width=this.qrcodeWidth,t.height=this.qrcodeHeight,this.addChild(t),""!=this.logoUrl&&(null==this.logoLoader&&(this.logoLoader=new egret.ImageLoader,this.logoLoader.addEventListener(egret.Event.COMPLETE,this.onlogoComplete,this)),this.logoLoader.load(this.logoUrl))},s.onlogoComplete=function(e){var t=new egret.Bitmap(this.logoLoader.data);t.width=this.qrcodeWidth/4,t.height=this.qrcodeHeight/4,t.x=(this.qrcodeWidth-t.width)/2,t.y=(this.qrcodeHeight-t.height)/2,this.addChild(t)},s.clear=function(){for(var e=this.numChildren,t=e-1;t>=0;t--){var i=this.getChildAt(t);i.parent&&i.parent.removeChild(i)}},t}(egret.DisplayObjectContainer);egret.registerClass(QRCodeLoader,"QRCodeLoader");var ShakeTool=function(){function e(){this.count=0,this.timer=new egret.Timer(1e3)}var t=(__define,e),i=t.prototype;return i.shakeObj=function(e,t,i,s){this.target=e,this.initX=e.x,this.initY=e.y,this.maxDis=s,this.count=t*i,this.rate=i,this.timer.delay=1e3/i,this.timer.repeatCount=this.count,this.timer.addEventListener(egret.TimerEvent.TIMER,this.shaking,this),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.shakeComplete,this),this.timer.reset(),this.timer.start()},i.shaking=function(){egret.Tween.removeTweens(this),this.target.x=this.initX-this.maxDis+Math.random()*this.maxDis*2,this.target.y=this.initY-this.maxDis+Math.random()*this.maxDis*2,egret.Tween.get(this.target).to({x:this.initX,y:this.initY},999/this.rate)},i.shakeComplete=function(){egret.Tween.removeTweens(this),this.target.x=this.initX,this.target.y=this.initY,this.timer.removeEventListener(egret.TimerEvent.TIMER,this.shaking,this),this.timer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.shakeComplete,this)},e}();egret.registerClass(ShakeTool,"ShakeTool");var StringTool=function(){function e(){}var t=(__define,e);t.prototype;return e.getTimeString=function(e){var t="";return t=10>e?"0"+e:e.toString()},e.checkPhoneNum=function(e){var t=/^1\d{10}$/,i=t.test(e);return i},e}();egret.registerClass(StringTool,"StringTool");var CMovieClip=function(e){function t(){e.call(this),this.textureList=[],this.curFrame=0,this.totalFrame=0,this.delay=1e3/24,this.timer=new egret.Timer(this.delay)}__extends(t,e);var i=__define,s=t,n=s.prototype;return n.addTexture=function(e,t,i){this.textureList.length=0,this.texture=null;for(var s=t;i>=s;s++)this.textureList.push(RES.getRes(e+s+"_png")),console.log(e+s+"_png");this.texture=this.textureList[0],this.totalFrame=this.textureList.length,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2},n.play=function(){this.timer.hasEventListener(egret.TimerEvent.TIMER)||this.startTimer()},n.gotoAndPlay=function(e){this.gotoAndStop(e),this.play()},n.stop=function(){this.stopTimer()},n.gotoAndStop=function(e){this.texture=this.textureList[e-1],this.curFrame=e},n.startTimer=function(){this.timer.addEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.timer.reset(),this.timer.start()},n.onTimerHandler=function(){this.curFrame++,this.curFrame>this.totalFrame&&(this.curFrame=1),this.gotoAndStop(this.curFrame)},n.stopTimer=function(){null!=this.timer&&(this.timer.removeEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.timer.stop())},i(n,"frameRate",void 0,function(e){this.delay=Math.round(1e3/e),this.timer&&(this.timer.delay=this.delay)}),n.destory=function(){this.stopTimer(),this.timer=null;for(var e=this.textureList.length,t=0;e>t;t++)this.textureList[t].dispose();this.textureList.length=0},t}(egret.Bitmap);egret.registerClass(CMovieClip,"CMovieClip");var SimpleMC=function(e){function t(){e.call(this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.setMovieClip=function(e,t,i){var s=RES.getRes(e),n=RES.getRes(t),a=new egret.MovieClipDataFactory(n,s);this.movieClipData=a.generateMovieClipData(i),this.anchorOffsetX=32,this.anchorOffsetY=32},t}(egret.MovieClip);egret.registerClass(SimpleMC,"SimpleMC");var GameScene=function(e){function t(){e.call(this,"GameSceneSkin"),this.snd=SoundManager.getInstance(),this.enemyNumIconList=new Array,this.initGameOverPos=new egret.Point,this.campRoundList=[[12,5],[11,5],[11,6],[11,7],[12,7]],this.playerTankList=new Array,this.enemyTankList=new Array,this.bulletList=new Array,this.itemList=new Array,this.generateTimer=new egret.Timer(2e3),this.armorTimer=new egret.Timer(1e3),this.pauseTimer=new egret.Timer(1e3),this.bPlayerPause=!1,this.bEnemyPause=!1,this.gameStatus=GameStatus.waiting,this.totalScore=[0,0],this.wave=0,this.bEndLess=!1}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.initView()},s.onEnable=function(){window.changeBgColor(GameConst.color2),this.nextLevel()},s.onRemove=function(){},s.nextLevel=function(){this.gameStatus=GameStatus.waiting;var e=MapManager.getInstance();1==e.curLevel&&(this.initMap(),this.initKillList(),this.waveLabel.text="",this.totalScore=[0,0]),e.curLevel>=e.levelLimit&&0==this.bEndLess?(this.bEndLess=!0,this.wave=1,this.waveLabel.text="WAVE."+this.wave):this.bEndLess=!1,this.stageLabel.text=e.curLevel+"",this.resetGame(),this.startGame(),this.gameStatus=GameStatus.gameing},s.startGame=function(){this.snd.play(this.snd.start_stage),this.createMap(),this.setEnemyNumIcon(),this.setPlayerIcon(),this.initPlayer(),this.configListeners(),this.startGenerateTimer()},s.resetGame=function(){this.resetGameValue(),this.resetGameOverIcon(),this.clearEnemyNumIcon(),this.clearPlayerIcon(),this.clearEnemyTank(),this.clearPlayerTank(),this.clearBullet(),this.clearItem(),this.clearTile()},s.gameOver=function(){console.log("game over"),this.gameStatus=GameStatus.gameover,this.snd.play(this.snd.lose),this.playGameOverAnim();var e=this;egret.Tween.get(this).wait(2e3).call(function(){e.sendGameOver()})},s.gameWin=function(){if(console.log("game win"),this.bEndLess)this.wave+=1,this.waveLabel.text="WAVE."+this.wave,MapManager.getInstance().getEndLessLevelData(this.wave);else{this.gameStatus=GameStatus.gameover;var e=this;egret.Tween.get(this).wait(2e3).call(function(){e.deConfigListeners(),e.stopGenerateTimer(),e.stopArmorTimer(),e.stopPauseTimer(),LayerManager.getInstance().runScene(GameManager.getInstance().resultScene);var t={killList:e.killList,totalKillList:e.totalKillList,totalScore:e.totalScore,stage:MapManager.getInstance().curLevel,wave:e.wave,historyScore:GameConst.historyScore};GameManager.getInstance().resultScene.setResult(t,!1)})}},s.configListeners=function(){this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this)},s.deConfigListeners=function(){this.removeEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this)},s.onEnterFrame=function(){this.movePlayerTank(),this.moveEnemyTank(),this.moveBullet()},s.initMap=function(){MapManager.getInstance().initalize()},s.initKillList=function(){this.killList=[],this.totalKillList=[];for(var e=0;4>e;e++){this.killList[e]=[],this.totalKillList[e]=[];for(var t=0;4>t;t++)this.killList[e][t]=0,this.totalKillList[e][t]=0}},s.initView=function(){this.socket=ClientSocket.getInstance();var e=MapManager.getInstance();this.rowMax=e.rowMax,this.colMax=e.colMax,this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight,this.halfWidth=e.halfWidth,this.halfHeight=e.halfHeight,this.mapWidth=this.colMax*this.tileWidth,this.mapHeight=this.rowMax*this.tileHeight,this.tileList=[],this.mapList=[];for(var t=0;t<this.rowMax;t++){this.tileList[t]=[],this.mapList[t]=[];for(var i=0;i<this.colMax;i++)this.tileList[t][i]=null,this.mapList[t][i]=0}this.initGameOverPos.x=this.gameOverIcon.x,this.initGameOverPos.y=this.gameOverIcon.y},s.resetGameValue=function(){this.bPlayerPause=!1,this.bEnemyPause=!1;for(var e=0;2>e;e++)for(var t=0;4>t;t++)this.killList[e][t]=0},s.createMap=function(){var e=MapManager.getInstance(),t=e.levelList[e.curLevel-1],i=t.mapData;this.mapList=ArrayTool.copy2DArr(i);for(var s,n=GameFactory.getInstance(),a=0;a<this.rowMax;a++)for(var r=0;r<this.colMax;r++)if(s=i[a][r],0!=s){var o=n.getTile(s);o.x=r*this.tileWidth+this.halfWidth,o.y=a*this.tileHeight+this.halfHeight,o.row=a,o.col=r,s==TileEnum.river?this.footTileGroup.addChild(o):this.topTileGroup.addChild(o),this.tileList[a][r]=o}this.setCampWall()},s.setCampWall=function(){var e=this.tileList[12][6];if(null!=e){for(var t=this.campRoundList.length,i=0;t>i;i++){var s=this.campRoundList[i],n=this.tileList[s[0]][s[1]];if(null!=n&&n.type!=TileEnum.wall){n.recycle();var a=GameFactory.getInstance().getTile(TileEnum.wall);a.x=s[1]*this.tileWidth+this.halfWidth,a.y=s[0]*this.tileHeight+this.halfHeight,a.row=s[0],a.col=s[1],this.footTileGroup.addChild(a),this.tileList[s[0]][s[1]]=a,this.mapList[s[0]][s[1]]=TileEnum.wall}}this.tileList[e.row][e.col-1]&&this.tileList[e.row][e.col-1].setTileHalf(3),this.tileList[e.row-1][e.col-1]&&this.tileList[e.row-1][e.col-1].setTileHalf(5),this.tileList[e.row-1][e.col]&&this.tileList[e.row-1][e.col].setTileHalf(1),this.tileList[e.row-1][e.col+1]&&this.tileList[e.row-1][e.col+1].setTileHalf(4),this.tileList[e.row][e.col+1]&&this.tileList[e.row][e.col+1].setTileHalf(2)}},s.setCampSteel=function(){var e=this.tileList[12][6];if(null!=e){for(var t=this.campRoundList.length,i=0;t>i;i++){var s=this.campRoundList[i],n=this.tileList[s[0]][s[1]];null!=n&&n.recycle();var a=GameFactory.getInstance().getTile(TileEnum.steel);a.x=s[1]*this.tileWidth+this.halfWidth,a.y=s[0]*this.tileHeight+this.halfHeight,a.row=s[0],a.col=s[1],this.footTileGroup.addChild(a),this.tileList[s[0]][s[1]]=a,this.mapList[s[0]][s[1]]=TileEnum.steel}this.tileList[e.row][e.col-1].setTileHalf(3),this.tileList[e.row-1][e.col-1].setTileHalf(5),this.tileList[e.row-1][e.col].setTileHalf(1),this.tileList[e.row-1][e.col+1].setTileHalf(4),this.tileList[e.row][e.col+1].setTileHalf(2)}},s.initPlayer=function(){var e=UserManager.getInstance().getUserNum();if(e>=1){var t=parseInt(this.p1LifeLabel.text);t>=1&&this.createPlayer(1)}if(2==e){var i=parseInt(this.p2LifeLabel.text);i>=1&&this.createPlayer(2)}},s.createPlayer=function(e){var t=UserManager.getInstance(),i=(t.getUserNum(),MapManager.getInstance()),s=i.levelList[i.curLevel-1],n=s.friendBirthPos,a=GameFactory.getInstance().getTank(TankEnum.player);a.y=n[e-1][1]*this.tileWidth+this.tileWidth/2,a.x=n[e-1][0]*this.tileHeight+this.tileWidth/2,a.openid=t.userList[e-1].openid,a.setPlayerNo(e),this.tankGroup.addChild(a),this.playerTankList.push(a),a.playShield(a.birthShieldTime)},s.setEnemyNumIcon=function(){if(this.bEndLess);else for(var e=MapManager.getInstance().getCurLevelData(),t=e.tankList,i=t.length,s=Math.ceil(i/2),n=0;s>n;n++)for(var a=0;2>a;a++){if(2*n+a>=i)return;var r=new EnemyNumIcon;r.x=r.width*a+3*a,r.y=r.height*n+3*n,this.enemyNumIconList.push(r),this.enemyNumGroup.addChild(r)}},s.clearEnemyNumIcon=function(){for(var e=this.enemyNumIconList.length,t=0;e>t;t++){var i=this.enemyNumIconList[t];i.parent&&i.parent.removeChild(i)}this.enemyNumIconList.length=0},s.reduceEnemyNumIcon=function(){var e=this.enemyNumIconList.length;if(e>0){var t=this.enemyNumIconList.pop();t.parent&&t.parent.removeChild(t)}},s.setPlayerIcon=function(){if(1==MapManager.getInstance().curLevel){var e=UserManager.getInstance().getUserNum(),t=MapManager.getInstance().playerSet.life;e>=1&&(this.p1Label.visible=!0,this.p1LifeLabel.visible=!0,this.p1Icon.visible=!0,this.p1LifeLabel.text=t+""),2==e&&(this.p2Label.visible=!0,this.p2LifeLabel.visible=!0,this.p2Icon.visible=!0,this.p2LifeLabel.text=t+"")}},s.reducePlayerIcon=function(e,t){if(void 0===t&&(t=1),1==e){var i=parseInt(this.p1LifeLabel.text);this.p1LifeLabel.text=i-t+""}else if(2==e){var i=parseInt(this.p2LifeLabel.text);this.p2LifeLabel.text=i-t+""}},s.checkPlayerAllDie=function(){var e=UserManager.getInstance().getUserNum();if(1==e){var t=parseInt(this.p1LifeLabel.text);if(0>=t&&0==this.playerTankList.length)return!0}else if(2==e){var i=parseInt(this.p1LifeLabel.text),s=parseInt(this.p2LifeLabel.text);if(0>=i&&0>=s&&0==this.playerTankList.length)return!0}return!1},s.clearPlayerIcon=function(){1==MapManager.getInstance().curLevel&&(this.p1Label.visible=!1,this.p2Label.visible=!1,this.p1LifeLabel.visible=!1,this.p2LifeLabel.visible=!1,this.p1Icon.visible=!1,this.p2Icon.visible=!1,this.p1LifeLabel.text="0",this.p2LifeLabel.text="0")},s.checkEnemyAllDie=function(){return 0==this.enemyTankList.length&&0==this.enemyNumIconList.length?!0:!1},s.resetGameOverIcon=function(){this.gameOverIcon.x=this.initGameOverPos.x,this.gameOverIcon.y=this.initGameOverPos.y,this.gameOverIcon.visible=!1},s.playGameOverAnim=function(){this.gameOverIcon.visible=!0,egret.Tween.get(this.gameOverIcon).to({y:this.initGameOverPos.y-400},1e3)},s.clearEnemyTank=function(){for(var e=this.enemyTankList.length,t=0;e>t;t++){var i=this.enemyTankList[t];i.recycle()}this.enemyTankList.length=0},s.clearPlayerTank=function(){for(var e=this.playerTankList.length,t=0;e>t;t++){var i=this.playerTankList[t];i.recycle()}this.playerTankList.length=0},s.clearBullet=function(){for(var e=this.bulletList.length,t=0;e>t;t++){var i=this.bulletList[t];i.recycle()}this.bulletList.length=0},s.clearItem=function(){for(var e=this.itemList.length,t=0;e>t;t++){var i=this.itemList[t];i.recycle()}this.itemList.length=0},s.clearTile=function(){for(var e=0;e<this.rowMax;e++)for(var t=0;t<this.colMax;t++){var i=this.tileList[e][t];i&&i.recycle(),this.tileList[e][t]=null,this.mapList[e][t]=0}},s.movePlayerTank=function(){if(!this.bPlayerPause)for(var e,t,i,s=this.playerTankList.length,n=0;s>n;n++){e=this.playerTankList[n],e.updateShootCount();for(var a=this.enemyTankList.length,r=0;a>r;r++)if(t=this.enemyTankList[r],0==e.checkCollision(t)&&e.checkNextCollision(t))return;for(var o=this.playerTankList.length,r=0;o>r;r++)if(i=this.playerTankList[r],i!=e&&0==e.checkCollision(i)&&e.checkNextCollision(i))return;0==this.getCollioseTile(e).length&&0==this.checkEdge(e)&&e.move();for(var h=this.itemList.length,r=h-1;r>=0;r--){var l=this.itemList[r];if(l.checkCollision(e)&&this.checkItemEffect(l,e)&&(this.playScoreLabel(l,500,e.playerNo),this.itemList.splice(r,1),l.recycle(),l.type==ItemEnum.boom&&this.checkEnemyAllDie()))return void this.gameWin()}}},s.moveEnemyTank=function(){if(!this.bEnemyPause)for(var e,t,i,s=this.enemyTankList.length,n=0;s>n;n++){e=this.enemyTankList[n],e.shoot();for(var a=this.playerTankList.length,r=0;a>r;r++)if(t=this.playerTankList[r],0==e.checkCollision(t)&&e.checkNextCollision(t)){e.autoTurn(),e=null;
break}if(null!=e){for(var o=this.enemyTankList.length,r=0;o>r;r++)if(i=this.enemyTankList[r],i!=e&&0==e.checkCollision(i)&&e.checkNextCollision(i)){e.autoTurn(),e=null;break}if(null!=e){0==this.getCollioseTile(e).length&&0==this.checkEdge(e)?e.autoMove():(e.autoTurn(),this.modifyTankTurn(e));for(var h=this.itemList.length,r=h-1;r>=0;r--){var l=this.itemList[r];if(l.checkCollision(e)&&this.checkItemEffect(l,e)&&(this.itemList.splice(r,1),l.recycle(),l.type==ItemEnum.boom)){if(this.checkPlayerAllDie())return void this.gameOver();this.initPlayer();var c=parseInt(this.p1LifeLabel.text);c>=1&&this.reducePlayerIcon(1);var u=parseInt(this.p2LifeLabel.text);u>=1&&this.reducePlayerIcon(2)}}}}}},s.moveBullet=function(){for(var e,t=this.bulletList.length,i=t-1;i>=0;i--)if(e=this.bulletList[i],this.checkEdge(e))e.type==TankEnum.player&&this.snd.play(this.snd.fire_reach_wall),this.playBoom(e),this.bulletList.splice(i,1),e.recycle();else{for(var s=this.getCollioseTile(e),n=0;n<s.length;n++){var a=s[n];if(a.beAttacked(e)){if(a.type==TileEnum.camp&&this.gameStatus==GameStatus.gameing)return this.playBoom(e),this.playTankBoom(a.x,a.y),e.recycle(),this.bulletList.splice(i,1),a.setGameOver(),void this.gameOver();this.mapList[a.row][a.col]=0,this.tileList[a.row][a.col]=null,a.recycle()}else a.type==TileEnum.steel&&e.type==TankEnum.player&&this.snd.play(this.snd.fire_reach_wall)}if(s.length>0)this.playBoom(e),e.recycle(),this.bulletList.splice(i,1);else{for(var n=(this.bulletList.length,i-1);n>=0;n--){var r=this.bulletList[n];if(e!=r&&e.checkCollision(r)){e.recycle(),this.bulletList.splice(i,1),r.recycle(),this.bulletList.splice(n,1),i--,e=null;break}}if(null!=e){if(e.type==TankEnum.player)for(var o=this.enemyTankList.length,n=o-1;n>=0;n--){var h=this.enemyTankList[n];if(e.checkCollision(h)){if(h.isHaveItem&&(h.isHaveItem=!1,this.createItem(),this.snd.play(this.snd.gift)),h.beAttacked(e)){this.playScoreLabel(h,100*h.type,e.owner.playerNo),h.recycle(),this.enemyTankList.splice(n,1),this.playTankBoom(h.x,h.y);var l=e.owner.playerNo;if(this.killList[l-1][h.type-1]+=1,this.totalKillList[l-1][h.type-1]+=1,this.checkEnemyAllDie())return this.playBoom(e),e.recycle(),this.bulletList.splice(i,1),void this.gameWin()}else h.playMoveAnim(),this.bEnemyPause&&h.stop();this.playBoom(e),e.recycle(),this.bulletList.splice(i,1);break}}else for(var o=this.playerTankList.length,n=o-1;n>=0;n--){var h=this.playerTankList[n];if(e.checkCollision(h)){if(h.beAttacked(e)){if(h.actionHandler(ActionEnum.stopMove),h.recycle(),this.playerTankList.splice(n,1),this.playTankBoom(h.x,h.y),this.checkPlayerAllDie())return this.playBoom(e),e.recycle(),this.bulletList.splice(i,1),void this.gameOver();this.createPlayer(h.playerNo),this.reducePlayerIcon(h.playerNo)}this.playBoom(e),e.recycle(),this.bulletList.splice(i,1);break}}e.move()}}}},s.createItem=function(){for(var e=MapManager.getInstance(),t=e.levelList[e.curLevel-1],i=t.getRandomItem(),s=GameFactory.getInstance().getItem(i),n=[],a=(this.mapList.length,0);a<this.rowMax;a++)for(var r=0;r<this.colMax;r++)0==this.mapList[a][r]&&n.push([a,r]);var o=n[NumberTool.getRandomInt(0,n.length-1)];s.y=o[0]*this.tileWidth+this.halfWidth,s.x=o[1]*this.tileWidth+this.halfWidth,s.startFlash(),this.itemGroup.addChild(s),this.itemList.push(s)},s.checkItemEffect=function(e,t){if(e.type==ItemEnum.shield){if(t.type!=TankEnum.player)return!1;var i=t;i.playShield(1e3*i.itemShieldTime)}else if(e.type==ItemEnum.gun)t.setPower(3);else if(e.type==ItemEnum.star)t.setPower(t.power+1);else if(e.type==ItemEnum.armor)t.type==TankEnum.player?(this.setCampSteel(),this.startArmorTimer()):(this.setCampWall(),this.stopArmorTimer());else if(e.type==ItemEnum.life){if(t.type!=TankEnum.player)return!1;this.snd.play(this.snd.gift_life),this.reducePlayerIcon(t.playerNo,-1)}else if(e.type==ItemEnum.boom)if(this.snd.play(this.snd.gift_bomb),t.type==TankEnum.player){for(var s=this.enemyTankList.length,n=0;s>n;n++){var t=this.enemyTankList[n];t.recycle(),this.playTankBoom(t.x,t.y),this.reduceEnemyNumIcon()}this.enemyTankList.length=0}else{for(var s=this.playerTankList.length,n=0;s>n;n++){var t=this.playerTankList[n];t.recycle(),this.playTankBoom(t.x,t.y),this.reducePlayerIcon(t.playerNo)}this.playerTankList.length=0}else if(e.type==ItemEnum.pause)if(t.type==TankEnum.player){this.bEnemyPause=!0,this.startPauseTimer();for(var s=this.enemyTankList.length,n=0;s>n;n++){var t=this.enemyTankList[n];t.stop()}}else{this.bPlayerPause=!0,this.startPauseTimer();for(var s=this.playerTankList.length,n=0;s>n;n++){var t=this.playerTankList[n];t.stop()}}return!0},s.modifyTankTurn=function(e){if(this.getCollioseTile(e).length>0){var t=Math.floor(e.x/this.tileWidth),i=Math.floor(e.y/this.tileHeight),s=t,n=i,a=e.direction;if(a==DirectionEnum.up?n-=1:a==DirectionEnum.down?n+=1:a==DirectionEnum.left?s-=1:a==DirectionEnum.right&&(s+=1),null!=this.tileList[i][t]&&0==this.tileList[i][t].canWalk)return;if((i!=n||t!=s)&&n>=0&&n<this.rowMax&&s>=0&&s<this.colMax){var r=this.tileList[n][s];(null==r||1==r.canWalk)&&(e.x=t*this.tileWidth+this.halfWidth+e.speedX,e.y=i*this.tileHeight+this.halfHeight+e.speedY)}}},s.playBoom=function(e){var t=GameFactory.getInstance().getBoom();t.x=e.x,t.y=e.y,this.boomGroup.addChild(t),t.playBoom()},s.playScoreLabel=function(e,t,i){var s=GameFactory.getInstance().getScoreLabel();s.x=e.x,s.y=e.y,s.setScoreLabel(t),this.topGroup.addChild(s),this.totalScore[i-1]+=t},s.playTankBoom=function(e,t){var i=GameFactory.getInstance().getTankBoom();i.x=e,i.y=t,this.boomGroup.addChild(i),i.playBoom()},s.checkEdge=function(e){var t=e.x+e.speedX,i=e.y+e.speedY;return t-e.hitHalfWidth<0?!0:t+e.hitHalfWidth>this.mapWidth?!0:i-e.hitHalfWidth<0?!0:i+e.hitHalfWidth>this.mapHeight?!0:!1},s.getCollioseTile=function(e){for(var t=[],i=Math.floor(e.x/this.tileWidth),s=Math.floor(e.y/this.tileWidth),n=this.getRoundTile(s,i),a=n.length,r=0;a>r;r++){var o=n[r];null!=o&&(e instanceof Bullet&&o.canHit?o.checkCollision(e)&&t.push(o):e instanceof Bullet==0&&0==o.canWalk&&o.checkCollision(e)&&t.push(o))}return t},s.getRoundTile=function(e,t){var i=[];return i.push(this.tileList[e][t]),e-1>=0&&(i.push(this.tileList[e-1][t]),t-1>=0&&i.push(this.tileList[e-1][t-1]),t+1<this.colMax&&i.push(this.tileList[e-1][t+1])),t-1>=0&&i.push(this.tileList[e][t-1]),t+1<this.colMax&&i.push(this.tileList[e][t+1]),e+1<this.rowMax&&(i.push(this.tileList[e+1][t]),t-1>=0&&i.push(this.tileList[e+1][t-1]),t+1<this.colMax&&i.push(this.tileList[e+1][t+1])),i},s.startGenerateTimer=function(){this.generateTimer.addEventListener(egret.TimerEvent.TIMER,this.onGenerateTank,this),this.generateTimer.reset(),this.generateTimer.start()},s.onGenerateTank=function(){var e=MapManager.getInstance(),t=e.levelList[e.curLevel-1],i=t.tankLimit;if(!(this.enemyTankList.length>=i)){var s=t.tankList;if(s.length>0){var n=s.pop();this.reduceEnemyNumIcon();var a=t.enemyBirthPos,r=a[NumberTool.getRandomInt(0,a.length-1)],o=this,h=GameFactory.getInstance().getFlash();h.x=r[0]*this.tileWidth+this.halfWidth,h.y=r[1]*this.tileWidth+this.halfHeight,this.tankGroup.addChild(h),h.playAnim(),egret.Tween.get(this).wait(1200).call(function(){var e=GameFactory.getInstance().getTank(n);e.x=r[0]*o.tileWidth+o.halfWidth,e.y=r[1]*o.tileWidth+o.halfHeight,Math.random()<t.itemNum/(s.length+1)&&(t.itemNum--,e.isHaveItem=!0),e.autoTurn(),o.bEnemyPause&&e.stop(),o.tankGroup.addChild(e),o.enemyTankList.push(e)})}}},s.stopGenerateTimer=function(){this.generateTimer.removeEventListener(egret.TimerEvent.TIMER,this.onGenerateTank,this),this.generateTimer.stop()},s.startArmorTimer=function(){this.armorTimer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.onArmorComplete,this),this.armorTimer.repeatCount=MapManager.getInstance().itemSet.armor,this.armorTimer.reset(),this.armorTimer.start()},s.onArmorComplete=function(){this.stopArmorTimer(),this.setCampWall()},s.stopArmorTimer=function(){this.armorTimer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.onArmorComplete,this),this.armorTimer.stop()},s.startPauseTimer=function(){this.pauseTimer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.onPauseComplete,this),this.pauseTimer.repeatCount=MapManager.getInstance().itemSet.pause,this.pauseTimer.reset(),this.pauseTimer.start()},s.onPauseComplete=function(){if(this.stopPauseTimer(),this.bEnemyPause)for(var e=this.enemyTankList.length,t=0;e>t;t++){var i=this.enemyTankList[t];i.playMoveAnim()}this.bPlayerPause=!1,this.bEnemyPause=!1},s.stopPauseTimer=function(){this.pauseTimer.removeEventListener(egret.TimerEvent.TIMER_COMPLETE,this.onPauseComplete,this),this.pauseTimer.stop()},s.sendGameOver=function(){for(var e=UserManager.getInstance().getUserNum(),t=0,i=0,s=0,n=0,a="",r="",o=0;4>o;o++)t+=this.totalKillList[0][o],i+=this.totalKillList[1][o];e>=1&&(a=UserManager.getInstance().userList[0].openid,s=this.totalScore[0]),2==e&&(r=UserManager.getInstance().userList[1].openid,n=this.totalScore[1]);var h={p1Kill:t,p2Kill:i,p1Score:s,p2Score:n,wave:this.wave,p1Openid:a,p2Openid:r,stage:MapManager.getInstance().curLevel};console.log("send gameOver:",h),this.socket.sendMessage("gameOver",h)},s.revGameOver=function(e){console.log("revGameOver:",e),this.deConfigListeners(),this.stopGenerateTimer(),this.stopArmorTimer(),this.stopPauseTimer(),LayerManager.getInstance().runScene(GameManager.getInstance().resultScene);var t=e.message,i=(e.success,{killList:this.killList,totalKillList:this.totalKillList,stage:MapManager.getInstance().curLevel,wave:this.wave,totalScore:this.totalScore,historyScore:t.historyScore,heroRank:t.heroRank,p1KillRank:t.p1KillRank,p2KillRank:t.p2KillRank});GameManager.getInstance().resultScene.setResult(i,!0)},s.revAction=function(e){var t=e.actionType,i=e.openid;if(this.gameStatus==GameStatus.gameing&&!this.bPlayerPause)for(var s=0;s<this.playerTankList.length;s++){var n=this.playerTankList[s];n.openid==i&&(t==ActionEnum.shoot?n.shoot():(n.actionHandler(t),this.modifyTankTurn(n)))}},t}(BaseScene);egret.registerClass(GameScene,"GameScene");var BaseItem=function(e){function t(){e.call(this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.setType=function(e){this.type=e,this.bitmapData=RES.getRes("item"+e+"_png"),this.anchorOffsetX=32,this.anchorOffsetY=32},s.startFlash=function(){egret.Tween.get(this,{loop:!0}).wait(200).to({alpha:0}).wait(200).to({alpha:1})},s.stopFlash=function(){this.alpha=1,egret.Tween.removeTweens(this)},s.checkCollision=function(e){return Math.abs(this.x-e.x)<64&&Math.abs(this.y-e.y)<64?!0:!1},s.recycle=function(){this.stopFlash(),this.parent&&this.parent.removeChild(this),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="BaseItem",t}(egret.Bitmap);egret.registerClass(BaseItem,"BaseItem");var Boom=function(e){function t(){e.call(this),this.setMovieClip("boom_png","boom_json","boom"),this.addEventListener(egret.MovieClipEvent.COMPLETE,this.recycle,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playBoom=function(){this.gotoAndPlay(1,1)},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.gotoAndStop(1),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="Boom",t}(SimpleMC);egret.registerClass(Boom,"Boom");var Bullet=function(e){function t(){e.call(this),this.speed=8,this.speedX=0,this.speedY=0,this.power=0,this.type=0,this.hitWidth=16,this.hitHalfWidth=8,this.bitmapData=RES.getRes("bullet_png"),this.anchorOffsetX=16,this.anchorOffsetY=16}__extends(t,e);var i=(__define,t),s=i.prototype;return s.move=function(){this.x+=this.speedX,this.y+=this.speedY},s.checkCollision=function(e){return Math.abs(this.x-e.x)<e.hitHalfWidth+this.hitHalfWidth&&Math.abs(this.y-e.y)<e.hitHalfWidth+this.hitHalfWidth?!0:!1},s.reset=function(){this.speedX=0,this.speedY=0,this.power=1,this.rotation=0,this.owner=null},s.recycle=function(){this.reset(),this.parent&&this.parent.removeChild(this),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="Bullet",t}(egret.Bitmap);egret.registerClass(Bullet,"Bullet");var EnemyNumIcon=function(e){function t(){e.call(this),this.bitmapData=RES.getRes("game_enemyNum_png")}__extends(t,e);var i=(__define,t);i.prototype;return t}(egret.Bitmap);egret.registerClass(EnemyNumIcon,"EnemyNumIcon");var Flash=function(e){function t(){e.call(this),this.setMovieClip("flash_png","flash_json","flash"),this.anchorOffsetX=32,this.anchorOffsetY=32}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playAnim=function(){this.gotoAndPlay(1,1),this.addEventListener(egret.MovieClipEvent.COMPLETE,this.recycle,this)},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.gotoAndStop(1),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="Flash",t}(SimpleMC);egret.registerClass(Flash,"Flash");var ScoreLabel=function(e){function t(){e.call(this),this.skinName="ScoreLabelSkin"}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.anchorOffsetX=35,this.anchorOffsetY=35},s.setScoreLabel=function(e){this.scoreLabel.text=e+"";var t=this;egret.Tween.get(this).wait(500).call(function(){t.recycle()},this)},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.scoreLabel.text="0",ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="ScoreLabel",t}(BaseUI);egret.registerClass(ScoreLabel,"ScoreLabel");var Shield=function(e){function t(){e.call(this),this.setMovieClip("shield_png","shield_json","shield")}__extends(t,e);var i=(__define,t);i.prototype;return t}(SimpleMC);egret.registerClass(Shield,"Shield");var TankBoom=function(e){function t(){e.call(this),this.setMovieClip("tankBoom_png","tankBoom_json","tankBoom"),this.anchorOffsetX=64,this.anchorOffsetY=64,this.addEventListener(egret.MovieClipEvent.COMPLETE,this.recycle,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playBoom=function(){this.gotoAndPlay(1,1)},s.onComplete=function(){this.recycle()},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.gotoAndStop(1),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="TankBoom",t}(SimpleMC);egret.registerClass(TankBoom,"TankBoom");var BaseTank=function(e){function t(){e.call(this),this.className="",this.speed=4,this.speedX=0,this.speedY=0,this.power=0,this.life=0,this.shootTime=0,this.shootCount=0,this.hitWidth=64,this.hitHalfWidth=32,this.snd=SoundManager.getInstance(),this.turnCount=60,this.className=egret.getQualifiedClassName(this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.reset=function(){this.speedX=0,this.speedY=0,this.isHaveItem=!1,this.shootCount=0},s.move=function(){this.x+=this.speedX,this.y+=this.speedY},s.playMoveAnim=function(){},s.setPower=function(e){e>=3&&(e=3),this.power=e},s.actionHandler=function(e){switch(0==this.speedX&&0==this.speedY&&e!=ActionEnum.stopMove&&(this.playMoveAnim(),this.type==TankEnum.player&&this.snd.play(this.snd.user_move,9999)),e){case ActionEnum.up:this.speedX=0,this.speedY=-this.speed,this.rotation=0,this.direction=DirectionEnum.up;break;case ActionEnum.down:this.speedX=0,this.speedY=this.speed,this.rotation=180,this.direction=DirectionEnum.down;break;case ActionEnum.left:this.speedX=-this.speed,this.speedY=0,this.rotation=-90,this.direction=DirectionEnum.left;break;case ActionEnum.right:this.speedX=this.speed,this.speedY=0,this.rotation=90,this.direction=DirectionEnum.right;break;case ActionEnum.stopMove:this.speedX=0,this.speedY=0,this.stop(),this.snd.stop(this.snd.user_move)}},s.autoTurn=function(){if(this.direction!=DirectionEnum.down&&Math.random()>.6)var e=ActionEnum.down;else e=NumberTool.getRandomInt(ActionEnum.up,ActionEnum.right);this.actionHandler(e)},s.autoMove=function(){this.move()},s.updateShootCount=function(){this.shootCount++},s.shoot=function(){if(this.shootCount++,16*this.shootCount>=this.shootTime){this.type==TankEnum.player&&this.snd.play(this.snd.fire),this.shootCount=0;var e=GameFactory.getInstance().bulletPool.getObject();switch(e.type=this.type,e.power=this.power,e.x=this.x,e.y=this.y,e.owner=this,this.direction){case DirectionEnum.up:e.rotation=0,e.speedY=-e.speed+(this.power-1);break;case DirectionEnum.down:e.rotation=180,e.speedY=e.speed+(this.power-1);break;case DirectionEnum.left:e.rotation=-90,e.speedX=-e.speed+(this.power-1);break;case DirectionEnum.right:e.rotation=90,e.speedX=e.speed+(this.power-1)}var t=GameManager.getInstance().gameScene;t.bulletList.push(e),t.bulletGroup.addChild(e)}},s.checkNextCollision=function(e){var t=this.x+this.speedX,i=this.y+this.speedY;return Math.abs(e.x-t)<64&&Math.abs(e.y-i)<64?!0:!1},s.checkCollision=function(e){return Math.abs(e.x-this.x)<64&&Math.abs(e.y-this.y)<64?!0:!1},s.beAttacked=function(e){return this.life-=e.power,this.life<=0?!0:!1},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.reset(),ObjectPool.getPool(this.className).returnObject(this)},t}(SimpleMC);egret.registerClass(BaseTank,"BaseTank");var FastTank=function(e){function t(){e.call(this),this.setMovieClip("fastTank_png","fastTank_json","fastTank"),this.reset()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playMoveAnim=function(){this.isHaveItem?this.gotoAndPlay("haveItem",-1):this.gotoAndPlay("normal",-1)},s.reset=function(){e.prototype.reset.call(this);var t=MapManager.getInstance().tankSet.fastTank;this.speed=t.speed,this.power=t.power,this.life=t.life,this.shootTime=t.shootTime[0],this.type=TankEnum.fast,this.gotoAndStop("normal")},t.NAME="FastTank",t}(BaseTank);egret.registerClass(FastTank,"FastTank");var NormalTank=function(e){function t(){e.call(this),this.setMovieClip("normalTank_png","normalTank_json","normalTank"),this.reset()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playMoveAnim=function(){this.isHaveItem?this.gotoAndPlay("haveItem",-1):this.gotoAndPlay("normal",-1)},s.reset=function(){e.prototype.reset.call(this);var t=MapManager.getInstance().tankSet.normalTank;this.speed=t.speed,this.power=t.power,this.life=t.life,this.shootTime=t.shootTime[0],this.type=TankEnum.normal,this.gotoAndStop("normal")},t.NAME="NormalTank",t}(BaseTank);egret.registerClass(NormalTank,"NormalTank");var PlayerTank=function(e){function t(){e.call(this),this.shield=new Shield,this.birthShieldTime=30,this.itemShieldTime=100,this.setMovieClip("playerYellowTank_png","playerYellowTank_json","playerYellowTank"),this.reset()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.move=function(){this.x+=this.speedX,this.y+=this.speedY,this.shield.parent&&(this.shield.x=this.x,this.shield.y=this.y)},s.playShield=function(e){this.parent&&(this.parent.addChild(this.shield),this.shield.x=this.x,this.shield.y=this.y,this.shield.play(e),this.shield.addEventListener(egret.MovieClipEvent.COMPLETE,this.onShieldComplete,this))},s.onShieldComplete=function(){this.shield.removeEventListener(egret.MovieClipEvent.COMPLETE,this.onShieldComplete,this),this.shield.parent&&this.shield.parent.removeChild(this.shield)},s.beAttacked=function(t){return this.shield.parent?!1:e.prototype.beAttacked.call(this,t)},s.setPlayerNo=function(e){this.playerNo=e,1==this.playerNo?this.setMovieClip("playerYellowTank_png","playerYellowTank_json","playerYellowTank"):this.setMovieClip("playerGreenTank_png","playerGreenTank_json","playerGreenTank")},s.playMoveAnim=function(){this.gotoAndPlay("lvl"+this.power,-1)},s.setPower=function(e){e>=3&&(e=3),this.power!=e&&(this.power=e,this.gotoAndPlay("lvl"+this.power,-1))},s.reset=function(){e.prototype.reset.call(this);var t=MapManager.getInstance().tankSet.playerTank;this.speed=t.speed,this.power=t.power,this.life=t.life,this.shootTime=t.shootTime[0],this.type=TankEnum.player,this.rotation=0,this.direction=DirectionEnum.up,this.gotoAndStop("lvl1");var i=MapManager.getInstance().itemSet;this.itemShieldTime=Math.round(i.shield/160),this.itemShieldTime<=0&&(this.itemShieldTime=1)},t.NAME="PlayerTank",t}(BaseTank);egret.registerClass(PlayerTank,"PlayerTank");var StrongTank=function(e){function t(){e.call(this),this.setMovieClip("strongTank_png","strongTank_json","strongTank"),this.reset()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playMoveAnim=function(){this.isHaveItem?this.gotoAndPlay("haveItem",-1):2==this.life?this.gotoAndPlay("lvl2",-1):this.gotoAndPlay("lvl1",-1)},s.reset=function(){e.prototype.reset.call(this);var t=MapManager.getInstance().tankSet.strongTank;this.speed=t.speed,this.power=t.power,this.life=t.life,this.shootTime=t.shootTime[0],this.type=TankEnum.strong,this.gotoAndStop("lvl2")},t.NAME="StrongTank",t}(BaseTank);egret.registerClass(StrongTank,"StrongTank");var SuperTank=function(e){function t(){e.call(this),this.setMovieClip("superTank_png","superTank_json","superTank"),this.reset()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.playMoveAnim=function(){this.isHaveItem?this.gotoAndPlay("haveItem",-1):3==this.life?this.gotoAndPlay("lvl3",-1):2==this.life?this.gotoAndPlay("lvl2",-1):this.gotoAndPlay("lvl1",-1)},s.reset=function(){e.prototype.reset.call(this);var t=MapManager.getInstance().tankSet.superTank;this.speed=t.speed,this.power=t.power,this.life=t.life,this.shootTime=t.shootTime[0],this.type=TankEnum["super"],this.gotoAndStop("lvl3")},t.NAME="SuperTank",t}(BaseTank);egret.registerClass(SuperTank,"SuperTank");var BaseTile=function(e){function t(){e.call(this),this.className="",this.life=0,this.canHit=!1,this.canWalk=!1,this.className=egret.getQualifiedClassName(this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.reset=function(){},s.setType=function(e){this.type=e,this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2},s.beAttacked=function(e){return!1},s.checkCollision=function(e){var t=e.x+e.speedX,i=e.y+e.speedY;return Math.abs(t-this.x)<32+e.hitHalfWidth&&Math.abs(i-this.y)<32+e.hitHalfWidth?!0:!1},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.reset(),ObjectPool.getPool(this.className).returnObject(this)},t}(BaseUI);egret.registerClass(BaseTile,"BaseTile");var Camp=function(e){function t(){e.call(this),this.gameOverPos=new egret.Point,this.skinName="CampSkin",this.setType(TileEnum.camp),this.canHit=!0,this.canWalk=!1}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.reset()},s.beAttacked=function(e){return!0},s.reset=function(){this.setNormal()},s.setNormal=function(){this.normal.visible=!0,this.destoryImg.visible=!1},s.setGameOver=function(){this.normal.visible=!1,this.destoryImg.visible=!0},t.NAME="Camp",t}(BaseTile);egret.registerClass(Camp,"Camp");var Grass=function(e){function t(){e.call(this),this.skinName="GrassSkin",this.canHit=!1,this.canWalk=!0,this.setType(TileEnum.grass)}__extends(t,e);var i=(__define,t);i.prototype;return t.NAME="Grass",t}(BaseTile);egret.registerClass(Grass,"Grass");var River=function(e){function t(){e.call(this),this.skinName="RiverSkin",this.canHit=!1,this.canWalk=!1,this.setType(TileEnum.river)}__extends(t,e);var i=(__define,t);i.prototype;return t.NAME="River",t}(BaseTile);egret.registerClass(River,"River");var Steel=function(e){function t(){e.call(this),this.steelList=new Array,this.type=TileEnum.steel,this.skinName="SteelSkin",this.setType(TileEnum.steel),this.canHit=!0,this.canWalk=!1}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this);for(var t=0;4>t;t++){var i=this["steel"+t];i.anchorOffsetX=i.width/2,i.anchorOffsetY=i.height/2,i.x+=i.width/2,i.y+=i.height/2,this.steelList.push(i)}this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.reset()},s.reset=function(){for(var e=0;4>e;e++)this.steelList[e].visible=!0;this.life=4},s.setTileHalf=function(e){switch(e){case 0:this.steelList[2].visible=!1,this.steelList[3].visible=!1,this.life=2;break;case 1:this.steelList[0].visible=!1,this.steelList[1].visible=!1,this.life=2;break;case 2:this.steelList[1].visible=!1,this.steelList[3].visible=!1,this.life=2;break;case 3:this.steelList[0].visible=!1,this.steelList[2].visible=!1,this.life=2;break;case 4:this.steelList[0].visible=!1,this.steelList[1].visible=!1,this.steelList[3].visible=!1,this.life=1;break;case 5:this.steelList[0].visible=!1,this.steelList[1].visible=!1,this.steelList[2].visible=!1,this.life=1}},s.beAttacked=function(e){if(e.power<3)return!1;for(var t,i=this.steelList.length,s=0;i>s;s++)t=this.steelList[s],1==t.visible&&Math.abs(this.x+t.x-32-e.x)<=48&&Math.abs(this.y+t.y-32-e.y)<=48&&(t.visible=!1,this.life--);return this.life<=0?!0:!1},s.checkCollision=function(e){for(var t,i=e.x+e.speedX,s=e.y+e.speedY,n=0;4>n;n++)if(t=this.steelList[n],1==t.visible&&Math.abs(this.x+t.x-32-i)<16+e.hitHalfWidth&&Math.abs(this.y+t.y-32-s)<16+e.hitHalfWidth)return!0;return!1},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.reset(),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="Steel",t}(BaseTile);egret.registerClass(Steel,"Steel");var Wall=function(e){function t(){e.call(this),this.wallList=new Array,this.type=TileEnum.wall,this.skinName="WallSkin",this.setType(TileEnum.wall),this.canHit=!0,this.canWalk=!1}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this);for(var t=0;16>t;t++){var i=this["wall"+t];i.anchorOffsetX=i.width/2,i.anchorOffsetY=i.height/2,i.x+=i.width/2,i.y+=i.height/2,this.wallList.push(i)}this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2,this.reset()},s.reset=function(){for(var e=0;16>e;e++)this.wallList[e].visible=!0;this.life=16},s.setTileHalf=function(e){switch(e){case 0:for(var t=8;16>t;t++)this.wallList[t].visible=!1;this.life=8;break;case 1:for(var t=0;8>t;t++)this.wallList[t].visible=!1;this.life=8;break;case 2:for(var t=0;4>t;t++)for(var i=2;4>i;i++)this.wallList[4*t+i].visible=!1;this.life=8;break;case 3:for(var t=0;4>t;t++)for(var i=0;2>i;i++)this.wallList[4*t+i].visible=!1;this.life=8;break;case 4:for(var t=0;16>t;t++)this.wallList[t].visible=!1;for(var t=2;4>t;t++)for(var i=0;2>i;i++)this.wallList[4*t+i].visible=!0;this.life=4;break;case 5:for(var t=0;16>t;t++)this.wallList[t].visible=!1;for(var t=2;4>t;t++)for(var i=2;4>i;i++)this.wallList[4*t+i].visible=!0;this.life=4}},s.beAttacked=function(e){for(var t,i=0;16>i;i++)t=this.wallList[i],1==t.visible&&(0!=e.speedX?Math.abs(this.x+t.x-32-e.x)<=24&&Math.abs(this.y+t.y-32-e.y)<=40&&(t.visible=!1,this.life--):Math.abs(this.x+t.x-32-e.x)<=40&&Math.abs(this.y+t.y-32-e.y)<=24&&(t.visible=!1,this.life--));return this.life<=0?!0:!1},s.checkCollision=function(e){for(var t,i=e.x+e.speedX,s=e.y+e.speedY,n=0;16>n;n++)if(t=this.wallList[n],1==t.visible&&Math.abs(this.x+t.x-32-i)<8+e.hitHalfWidth&&Math.abs(this.y+t.y-32-s)<8+e.hitHalfWidth)return!0;return!1},s.recycle=function(){this.parent&&this.parent.removeChild(this),this.reset(),ObjectPool.getPool(t.NAME).returnObject(this)},t.NAME="Wall",t}(BaseTile);egret.registerClass(Wall,"Wall");var HeadUI=function(e){function t(){e.call(this),this.imageLoader=new egret.ImageLoader,this.skinName="HeadUISkin"}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.headImg=new egret.Bitmap,this.headImg.width=this.width,this.headImg.height=this.height,this.addChild(this.headImg)},s.createWenHao=function(){this.wenHao=new egret.Bitmap(RES.getRes("home_wenhao_png")),this.addChild(this.wenHao)},s.loadImg=function(e){this.clear(),""!=e&&null!=e&&(this.imageLoader.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onLoadError,this),this.imageLoader.addEventListener(egret.Event.COMPLETE,this.loadCompleteHandler,this),this.imageLoader.load(e))},s.loadCompleteHandler=function(e){var t=e.currentTarget;this.headImg.bitmapData=t.data,this.wenHao&&(this.wenHao.visible=!1)},s.onLoadError=function(){egret.log("加载头像错误")},s.isEmpty=function(){return null==this.headImg.bitmapData?!0:!1},s.clear=function(){this.headImg.bitmapData=null,this.openid="",this.wenHao&&(this.wenHao.visible=!0)},t}(BaseUI);egret.registerClass(HeadUI,"HeadUI");var HomeScene=function(e){function t(){e.call(this,"HomeSceneSkin"),this.countDownTimer=new egret.Timer(1e3),this.countDownLimit=1,this.rankHeadList=new Array,this.killHeadList=new Array}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.socket=ClientSocket.getInstance(),this.pHeadUIList=[this.p1HeadUI,this.p2HeadUI],this.p1HeadUI.createWenHao(),this.p2HeadUI.createWenHao();for(var t=0;5>t;t++){var i=this["rankHead"+t];i.clear(),this.rankHeadList.push(i)}for(var t=0;5>t;t++){var s=this["killHead"+t];s.clear(),this.killHeadList.push(s)}this.countDownLimit=GameConst.gameConfig.homeCountDown},s.onEnable=function(){window.changeBgColor(GameConst.color0),this.resetView(),this.createQRCode(),this.startConnect()},s.onRemove=function(){},s.resetView=function(){this.countDownLabel.text=this.countDownLimit+"";for(var e=0;e<this.pHeadUIList.length;e++){var t=this.pHeadUIList[e];t.clear()}},s.startGame=function(){this.sendStartGame(),MapManager.getInstance().curLevel=1,LayerManager.getInstance().runScene(GameManager.getInstance().transitionScene)},s.startCountDown=function(){this.countDownTimer.addEventListener(egret.TimerEvent.TIMER,this.onCountDownHandler,this),this.countDownTimer.reset(),this.countDownTimer.start()},s.onCountDownHandler=function(){var e=this.countDownLimit-this.countDownTimer.currentCount;this.countDownLabel.text=e+"",0>=e&&(this.stopCountDown(),this.startGame())},s.stopCountDown=function(){this.countDownTimer.removeEventListener(egret.TimerEvent.TIMER,this.onCountDownHandler,this),this.countDownTimer.stop()},s.createQRCode=function(){this.rid=window.createQRCode();var e=new QRCodeLoader,t=window.codeConfig;e.load(t.codeData,t.codeWidth,t.codeHeight,t.logoUrl),this.codeGroup.addChild(e),this.socket.isConnected()&&(this.sendUpRid(),this.sendRank())},s.startConnect=function(){0==this.socket.isConnected()&&this.socket.startConnect()},s.connect=function(){this.sendLogin()},s.sendLogin=function(){this.socket.sendMessage("login",{rid:this.rid,gid:GameConst.gameConfig.gid,userType:"pc"}),console.log("send login:","rid="+this.rid,"gid=",GameConst.gameConfig.gid)},s.revLogin=function(e){var t=e.success,i=e.msg;console.log("rev login:",e),0==t&&alert(i),this.sendRank()},s.sendRank=function(){this.socket.sendMessage("rank",{})},s.sendUpRid=function(){console.log("send upRid:","rid="+this.rid),this.socket.sendMessage("upRid",{rid:this.rid})},s.sendStartGame=function(){console.log("send startGame"),this.socket.sendMessage("startGame",{data:{}})},s.revUserJoin=function(e){console.log("rev userJoin:",e);var t=e.openid,i=e.headimgurl,s=e.nickname,n=new UserVO;n.openid=t,n.headimgurl=i,n.nickname=s,UserManager.getInstance().addUser(n);for(var a=0;a<this.pHeadUIList.length;a++){var r=this.pHeadUIList[a];if(r.isEmpty()){r.loadImg(i),r.openid=t;break}}this.startCountDown()},s.revRank=function(e){console.log("revRank:",e);for(var t=e.message,i=t.heroRankList,s=t.killRankList,n=t.historyScore,a=this.rankHeadList.length,r=0;a>r;r++){var o=this.rankHeadList[r];o.clear()}a=i.length,a=a>5?5:a;for(var r=0;a>r;r++)o=this.rankHeadList[r],o.setHead(i[r].p1HeadUrl,i[r].p2HeadUrl),o.setHistory(i[r].stage,i[r].wave);a=this.killHeadList.length,a=a>5?5:a;for(var r=0;a>r;r++){var h=this.killHeadList[r];h.clear()}a=s.length;for(var r=0;a>r;r++)h=this.killHeadList[r],h.setValue(s[r].headUrl,s[r].kill);this.historyLabel.text="HI-          "+n,GameConst.historyScore=n},s.revUserQuit=function(e){console.log("rev userQuit:",e);var t=e.openid;this.parent&&(UserManager.getInstance().deleteUser(t),this.p1HeadUI.openid==t?this.p1HeadUI.clear():this.p2HeadUI.openid==t&&this.p2HeadUI.clear(),UserManager.getInstance().getUserNum()<=0&&(this.stopCountDown(),this.countDownLabel.text=this.countDownLimit+""))},t}(BaseScene);egret.registerClass(HomeScene,"HomeScene");var KillHeadUI=function(e){function t(){e.call(this),this.skinName="KillHeadUISkin"}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this)},s.setValue=function(e,t){this.headUI.loadImg(e),this.killLabel.text="X  "+t,this._Label.visible=!0,this.tank.visible=!0
},s.clear=function(){this.headUI.clear(),this.killLabel.text="",this._Label.visible=!1,this.tank.visible=!1},t}(BaseUI);egret.registerClass(KillHeadUI,"KillHeadUI");var RankHeadUI=function(e){function t(){e.call(this),this.skinName="RankHeadSKin"}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this)},s.setHead=function(e,t){""!=e&&this.p1HeadUI.loadImg(e),""!=t&&this.p2HeadUI.loadImg(t)},s.setHistory=function(e,t){3>e?(this.stageLabel.text="-  STAGE"+e,this.waveLabel.text=""):(this.stageLabel.text="-  S"+e,this.waveLabel.text="WAVE."+t)},s.clear=function(){this.stageLabel.text="",this.waveLabel.text="",this.p1HeadUI.clear(),this.p2HeadUI.clear()},t}(BaseUI);egret.registerClass(RankHeadUI,"RankHeadUI");var PreloadScene=function(e){function t(){e.call(this,"PreloadSceneSkin")}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this)},s.setProgress=function(e){this.inited&&(this.progressLabel.text=e.toString()+"%")},t}(BaseScene);egret.registerClass(PreloadScene,"PreloadScene");var ResultScene=function(e){function t(){e.call(this,"ResultSceneSkin"),this.countDownTime=3e3}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.countDownTime=1e3*GameConst.gameConfig.resultCountDown},s.clear=function(){for(var e=0;4>e;e++)this["p1Tank"+e+"Label"].text="",this["p2Tank"+e+"Label"].text="",this["p1Score"+e+"Label"].text="",this["p2Score"+e+"Label"].text="";this.p1TotalLabel.text="",this.p2TotalLabel.text="",this.historyLabel.text=""},s.setResult=function(e,t,i){void 0===i&&(i=!1),this.clear(),this.historyLabel.text=e.historyScore+"",this.stageLabel.text="STAGE"+e.stage,i?this.waveLabel.text="WAVE."+e.wave:this.waveLabel.text="";var s=e.killList;e.totalKillList;this.p1ScoreLabel.text=e.totalScore[0]+"",1==UserManager.getInstance().getUserNum()?(this.p2ScoreGroup.visible=!1,this.p2ScoreLabel.text=""):(this.p2ScoreGroup.visible=!0,this.p2ScoreLabel.text=e.totalScore[1]+"");for(var n=0,a=0,r=0;4>r;r++)n+=s[0][r],a+=s[1][r];if(t){this.rankGroup.visible=!0;var o=UserManager.getInstance(),h=o.userList,l=h.length;l>=1&&this.p1RankHead.loadImg(h[0].headimgurl),2==l&&this.p2RankHead.loadImg(h[1].headimgurl),this.rankLabel.text=e.heroRank+"",l>=1&&this.p1KillHead.loadImg(h[0].headimgurl),2==l&&this.p2KillHead.loadImg(h[1].headimgurl),0!=e.p1KillRank?(this.p1Kill0Label.visible=!0,this.p1Kill1Label.visible=!0):(this.p1Kill0Label.visible=!1,this.p1Kill1Label.visible=!1),this.p1KillLabel.text=e.p1KillRank+"",0!=e.p2KillRank?(this.p2Kill0Label.visible=!0,this.p2Kill1Label.visible=!0):(this.p2Kill0Label.visible=!1,this.p2Kill1Label.visible=!1),2==l?this.p2KillLabel.text=e.p2KillRank+"":this.p2KillLabel.text=""}else this.rankGroup.visible=!1;var c=this;egret.Tween.get(this).wait(500).call(function(){c.p1Score0Label.text=100*s[0][0]+"",c.p1Tank0Label.text=s[0][0]+"",c.p2Score0Label.text=100*s[1][0]+"",c.p2Tank0Label.text=s[1][0]+""}).wait(500).call(function(){c.p1Score1Label.text=200*s[0][1]+"",c.p1Tank1Label.text=s[0][1]+"",c.p2Score1Label.text=200*s[1][1]+"",c.p2Tank1Label.text=s[1][1]+""}).wait(500).call(function(){c.p1Score2Label.text=300*s[0][2]+"",c.p1Tank2Label.text=s[0][2]+"",c.p2Score2Label.text=300*s[1][2]+"",c.p2Tank2Label.text=s[1][2]+""}).wait(500).call(function(){c.p1Score3Label.text=400*s[0][3]+"",c.p1Tank3Label.text=s[0][3]+"",c.p2Score3Label.text=400*s[1][3]+"",c.p2Tank3Label.text=s[1][3]+""}).wait(500).call(function(){c.p1TotalLabel.text=n+"",c.p2TotalLabel.text=a+""}).wait(this.countDownTime).call(function(){t?(MapManager.getInstance().curLevel=1,LayerManager.getInstance().runScene(GameManager.getInstance().homeScene)):(MapManager.getInstance().curLevel+=1,LayerManager.getInstance().runScene(GameManager.getInstance().transitionScene))})},t}(BaseScene);egret.registerClass(ResultScene,"ResultScene");var TransitionScene=function(e){function t(){e.call(this,"TransitionSceneSkin"),this.countDownTime=3e3}__extends(t,e);var i=(__define,t),s=i.prototype;return s.componentCreated=function(){e.prototype.componentCreated.call(this),this.countDownTime=1e3*GameConst.gameConfig.transitionCountDown},s.onEnable=function(){window.changeBgColor(GameConst.color7),this.setStageLabel()},s.setStageLabel=function(){this.stageLabel.text="STAGE  "+MapManager.getInstance().curLevel,MapManager.getInstance().levelLimit==MapManager.getInstance().curLevel?this.endLessGroup.visible=!0:this.endLessGroup.visible=!1,egret.Tween.get(this).wait(this.countDownTime).call(function(){LayerManager.getInstance().runScene(GameManager.getInstance().gameScene)})},t}(BaseScene);egret.registerClass(TransitionScene,"TransitionScene");var Main=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createChildren=function(){e.prototype.createChildren.call(this);var t=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",t),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this)},s.onThemeLoadComplete=function(){LoadManager.getInstance().loadGroup("preload",this,this.onPreloadComplete)},s.onPreloadComplete=function(e){this.preloadScene=new PreloadScene,this.addChild(this.preloadScene),LoadManager.getInstance().loadGroup("game",this,this.onGameComplete,this.onGameProgress)},s.onGameProgress=function(e){this.preloadScene.setProgress(Math.round(e.itemsLoaded/e.itemsTotal*100))},s.onGameComplete=function(){this.removeChild(this.preloadScene),this.preloadScene=null,GameManager.getInstance().startup(this)},t}(eui.UILayer);egret.registerClass(Main,"Main");var ThemeAdapter=function(){function e(){}var t=(__define,e),i=t.prototype;return i.getTheme=function(e,t,i,s){function n(e){t.call(s,e)}function a(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,a,null),i.call(s))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,a,null),RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);