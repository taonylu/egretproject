var ArrayTool=function(){function t(){}var e=(__define,t);return p=e.prototype,t.randomArr=function(t){for(var e,i,s,h=t.length;h;)i=h-1,s=Math.floor(Math.random()*h),h--,i!=s&&(e=t[i],t[i]=t[s],t[s]=e)},t.copy2DArr=function(t){for(var e=new Array,i=t.length,s=t[0].length,h=0;i>h;h++){var r=new Array;e.push(r);for(var n=0;s>n;n++)r.push(t[h][n])}return e},t.getObjectLen=function(t){var e=0;for(var i in t)e++;return e},t}();egret.registerClass(ArrayTool,"ArrayTool");var NumberTool=function(){function t(){}var e=(__define,t);return p=e.prototype,t.getRandomInt=function(t,e){return Math.round(Math.random()*(e-t))+t},t}();egret.registerClass(NumberTool,"NumberTool");var ObjectPool=function(){function t(t){this.className=t,this.list=[]}var e=(__define,t);return p=e.prototype,p.getObject=function(){if(this.list.length>0)return this.list.shift();var t=egret.getDefinitionByName(this.className);return new t},p.returnObject=function(t){this.list.push(t)},t.getPool=function(e,i){if(void 0===i&&(i=0),!t.pool[e]&&(t.pool[e]=new t(e),0!=i))for(var s=egret.getDefinitionByName(e),h=t.pool[e],r=0;i>r;r++)h.returnObject(new s);return t.pool[e]},t.pool={},t}();egret.registerClass(ObjectPool,"ObjectPool");var SimpleButton=function(t){function e(e,i){void 0===i&&(i=null),t.call(this),this.up=new egret.Bitmap(RES.getRes(e)),this.addChild(this.up),null!=i&&(this.down=new egret.Bitmap(RES.getRes(i)),this.addChild(this.down),this.down.visible=!1),this.touchEnabled=!0,this.touchChildren=!1,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.touchBegin,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.touchBegin=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onPress()},p.touchEnd=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onRelease()},p.onPress=function(){this.down&&(this.up.visible=!1,this.down&&(this.down.visible=!0))},p.onRelease=function(){this.down&&(this.up.visible=!0,this.down&&(this.down.visible=!1))},p.setText=function(t){null==this.displayText&&null!=this.up&&(this.displayText=new egret.TextField,this.displayText.width=this.up.width,this.displayText.height=this.up.height,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.displayText.textColor=0,this.addChild(this.displayText)),this.displayText.text=t},p.setTextColor=function(t){this.displayText&&(this.displayText.textColor=t)},p.setTextSize=function(t){this.displayText&&(this.displayText.size=t)},e}(egret.Sprite);egret.registerClass(SimpleButton,"SimpleButton");var GameConst=function(){function t(){}var e=(__define,t);return p=e.prototype,t.zheScore=[],t.zheList=[],t.totalScore=0,t}();egret.registerClass(GameConst,"GameConst");var GameScene=function(t){function e(){t.call(this),this.resultPanel=new ResultPanel,this.blockPool=ObjectPool.getPool(BlockUI.NAME,10),this.boomPool=ObjectPool.getPool(BoomUI.NAME,10),this.selectOld=new SelectUI,this.selectNew=new SelectUI,this.blockTypeNum=10,this.blockNum=0,this.blockData=new Array,this.tempMap=new Array,this.blockArr=new Array,this.rowMax=8,this.colMax=7,this.blockWidth=64,this.blockHeight=64,this.mapStartY=220,this.mapStartX=0,this.isSelect=!1,this.score=0,this.curLevel=1,this.timeLimit=10,this.totalScore=0,this.minRoadPoint=1e4,this.route=new Array}__extends(e,t);var i=(__define,e);return p=i.prototype,p.show=function(){GameConst.stage.addChild(this),this.initConfig(),this.initView()},p.initConfig=function(){var t=RES.getRes("config_json");null!=t&&(GameConst.zheScore=t.score,GameConst.zheList=t.discount,GameConst.totalScore=t.totalScore,this.timeLimit=t.time,this.blockTypeNum=t.picTypeNum)},p.initView=function(){this._stage=GameConst.stage,this.mapStartX=(this._stage.stageWidth-this.blockWidth*this.colMax)/2,this.gameBg=new egret.Bitmap(RES.getRes("game_bg_jpg")),this.addChild(this.gameBg),this.lineSprite=new egret.Sprite,this.lineSprite.x=this.mapStartX,this.lineSprite.y=this.mapStartY,this.lineSprite.width=this._stage.stageWidth,this.lineSprite.height=this._stage.stageHeight,this.lineSprite.touchChildren=!1,this.lineSprite.touchEnabled=!1,this.addChild(this.lineSprite),this.timeBg=new egret.Bitmap(RES.getRes("timebg_png")),this.timeBg.x=(this._stage.stageWidth-this.timeBg.width)/2,this.timeBg.y=20,this.addChild(this.timeBg),this.timeText=new egret.TextField,this.timeText.width=120,this.timeText.height=50,this.timeText.textAlign=egret.HorizontalAlign.CENTER,this.timeText.verticalAlign=egret.VerticalAlign.MIDDLE,this.timeText.x=this.timeBg.x+(this.timeBg.width-this.timeText.width)/2,this.timeText.y=this.timeBg.y+(this.timeBg.height-this.timeText.height)/2,this.addChild(this.timeText),this.setTimeText(this.timeLimit),this.scoreBarUI=new ScoreBarUI,this.scoreBarUI.x=(this._stage.stageWidth-this.scoreBarUI.scoreBg.width)/2,this.scoreBarUI.y=100,this.addChild(this.scoreBarUI),this.startBtn=new SimpleButton("start0_png","start1_png"),this.startBtn.x=(this._stage.stageWidth-this.startBtn.width)/2,this.startBtn.y=(this._stage.stageHeight-this.startBtn.height)/2,this.startBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onStartBtnTouch,this),this.addChild(this.startBtn)},p.onStartBtnTouch=function(){this.removeChild(this.startBtn),this.starGame()},p.starGame=function(){this.createMap(),this.startTimer(),this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTap,this)},p.nextLevel=function(){this.timeLimit>0?(this.curLevel++,this.resetGame(),this.createMap()):this.gameOver()},p.gameOver=function(){console.log("game over"),this.stopTimer(),this.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTap,this),this.showResult()},p.resetGame=function(){for(var t=this.blockArr.length,e=0;t>e;e++)null!=this.blockArr[e]&&this.blockArr[e].hideImmediately();this.blockArr.length=0,this.isSelect=!1,this.oldTarget=null,this.newTarget=null,this.minRoadPoint=1e4,this.route.length=0,this.blockNum=0,this.blockData.length=0,this.tempMap=null,this.selectOld.hide(),this.selectNew.hide()},p.createMap=function(){var t=RES.getRes("config_json");if(null!=t){var e=t["level"+this.curLevel];if(null==e)return void this.gameOver();this.tempMap=ArrayTool.copy2DArr(e);for(var i=0;i<this.rowMax;i++)for(var s=0;s<this.colMax;s++)this.tempMap[i][s]>0&&this.blockNum++;this.initBlockData(this.blockNum);for(var h=0,i=0;i<this.rowMax;i++)for(var s=0;s<this.colMax;s++)if(this.tempMap[i][s]>0){var r=this.blockPool.getObject();r.setSkin(this.blockData[h]),r.type=this.blockData[h],r.row=i,r.col=s,r.name=i+"_"+s,r.x=this.mapStartX+s*(this.blockWidth+1),r.y=this.mapStartY+i*(this.blockHeight+1)-this._stage.stageHeight,r.index=h,this.addChild(r),this.blockArr.push(r),egret.Tween.get(r).to({y:this.mapStartY+i*(this.blockHeight+1)},500),h++}}},p.initBlockData=function(t){for(var e=0;t/2>e;e++){var i=NumberTool.getRandomInt(1,this.blockTypeNum);this.blockData.push(i,i)}ArrayTool.randomArr(this.blockData)},p.onTouchTap=function(t){t.target instanceof BlockUI&&this.checkBlock(t.target)},p.checkBlock=function(t){if(this.isSelect&&(this.oldTarget=this.newTarget,this.selectOld.play(this.oldTarget)),this.newTarget=t,this.selectNew.play(this.newTarget),this.isSelect){if(this.newTarget!=this.oldTarget&&this.newTarget.type==this.oldTarget.type){if(this.checkRoad(this.oldTarget,this.newTarget)){this.linkRoad();var e=this.boomPool.getObject(),i=this.boomPool.getObject();return this.addChild(e),this.addChild(i),e.play(this.newTarget),i.play(this.oldTarget),this.oldTarget.hide(),this.newTarget.hide(),this.tempMap[this.oldTarget.row][this.oldTarget.col]=0,this.tempMap[this.newTarget.row][this.newTarget.col]=0,this.blockArr[this.oldTarget.index]=null,this.blockArr[this.newTarget.index]=null,this.oldTarget=this.newTarget=null,this.setScoreText(this.score+=20),this.selectOld.hide(),this.selectNew.hide(),this.isSelect=!1,void(this.checkGameOver()&&this.nextLevel())}return this.oldTarget=null,this.newTarget=null,this.selectOld.hide(),this.selectNew.hide(),void(this.isSelect=!1)}this.selectOld.hide();var s=this.selectOld;return this.selectOld=this.selectNew,void(this.selectNew=s)}this.isSelect=!0},p.checkRoad=function(t,e){console.log("checkRoad...");var i=t.row,s=t.col,h=e.row,r=e.col,n=!1;if(i==h){if(this.lineCheck(i,s,h,r))return this.route.push({x:s,y:i},{x:r,y:h}),!0;for(var o=0;o<this.rowMax;o++)0==this.tempMap[o][s]&&0==this.tempMap[o][r]&&this.lineCheck(i,s,o,s)&&this.lineCheck(o,s,o,r)&&this.lineCheck(o,r,h,r)&&(this.theShortest(i,s,o,s,o,r,h,r),n=!0)}else if(s==r){if(this.lineCheck(i,s,h,r))return this.route.push({x:s,y:i},{x:r,y:h}),!0;for(o=0;o<this.colMax;o++)0==this.tempMap[i][o]&&0==this.tempMap[h][o]&&this.lineCheck(i,s,i,o)&&this.lineCheck(i,o,h,o)&&this.lineCheck(h,o,h,r)&&(this.theShortest(i,s,i,o,h,o,h,r),n=!0)}else{if(0==this.tempMap[h][s]&&this.lineCheck(i,s,h,s)&&this.lineCheck(h,s,h,r))return this.route.push({x:s,y:i},{x:s,y:h},{x:r,y:h}),!0;if(0==this.tempMap[i][r]&&this.lineCheck(i,s,i,r)&&this.lineCheck(h,r,i,r))return this.route.push({x:s,y:i},{x:r,y:i},{x:r,y:h}),!0;for(o=0;o<this.colMax;o++)0==this.tempMap[i][o]&&0==this.tempMap[h][o]&&this.lineCheck(i,s,i,o)&&this.lineCheck(i,o,h,o)&&this.lineCheck(h,o,h,r)&&(this.theShortest(i,s,i,o,h,o,h,r),n=!0);for(o=0;o<this.rowMax;o++)0==this.tempMap[o][s]&&0==this.tempMap[o][r]&&this.lineCheck(i,s,o,s)&&this.lineCheck(o,s,o,r)&&this.lineCheck(o,r,h,r)&&(this.theShortest(i,s,o,s,o,r,h,r),n=!0)}return n},p.lineCheck=function(t,e,i,s){if(t==i){if(e>s){var h=e;e=s,s=h}if(e+1==s)return!0;for(var r=e+1;s>r;r++)if(this.tempMap[t][r]>0)return!1;return!0}if(e==s){if(t>i&&(h=t,t=i,i=h),t+1==i)return!0;for(r=t+1;i>r;r++)if(this.tempMap[r][e]>0)return!1;return!0}return!1},p.linkRoad=function(){this.lineSprite.graphics.lineStyle(5,16711680);for(var t=this.route.length-1,e=0;t>e;e++){var i=this.route[e],s=this.route[e+1],h=i.x*this.blockWidth+this.blockWidth/2,r=i.y*this.blockHeight+this.blockHeight/2,n=s.x*this.blockWidth+this.blockWidth/2,o=s.y*this.blockHeight+this.blockHeight/2;this.lineSprite.graphics.moveTo(h,r),this.lineSprite.graphics.lineTo(n,o)}this.lineSprite.graphics.endFill(),this.route.length=0,this.minRoadPoint=1e4;var a=this;setTimeout(function(){a.lineSprite.graphics.clear()},300)},p.theShortest=function(t,e,i,s,h,r,n,o){var a=0;a=Math.abs(i-t)+Math.abs(h-i)+Math.abs(n-h)+Math.abs(s-e)+Math.abs(r-s)+Math.abs(o-r),a<=this.minRoadPoint&&(this.route[0]={x:e,y:t},this.route[1]={x:s,y:i},this.route[2]={x:r,y:h},this.route[3]={x:o,y:n},this.minRoadPoint=a)},p.sortBlock=function(){ArrayTool.randomArr(this.blockData);for(var t,e=this.blockArr.length,i=0;e>i;i++)t=this.blockArr[i],null!=t&&(t.setSkin(this.blockData[t.index]),t.type=this.blockData[t.index])},p.checkGameOver=function(){for(var t=0;t<this.rowMax;t++)for(var e=0;e<this.colMax;e++)if(this.tempMap[t][e]>0)return!1;return!0},p.setScoreText=function(t){this.scoreBarUI.setScore(t)},p.setTimeText=function(t){this.timeText.text="时间:"+t.toString()},p.submitScore=function(){this.request=new egret.HttpRequest,this.request.addEventListener(egret.Event.COMPLETE,this.onComplete,this),this.request.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onError,this),this.request.responseType=egret.HttpResponseType.TEXT,this.request.open("http://httpbin.org/post",egret.HttpMethod.POST),this.request.send()},p.onComplete=function(t){console.log("post data : ",this.request.response),console.log(t.data),this.showResult()},p.onError=function(){console.log("加载错误")},p.showResult=function(){this.resultPanel.show(this);var t=this.scoreBarUI.curZhe,e="";0>=t?e+="很遗憾，未获得折扣":(e+="获得:"+t+"折",e+="\n￥1000   -￥"+Math.round(1e3*(1-t/10))),e+="\n获得天天币:100",this.resultPanel.setText(e)},p.startTimer=function(){null==this.gameTimer&&(this.gameTimer=new egret.Timer(1e3)),this.gameTimer.addEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.gameTimer.reset(),this.gameTimer.start()},p.onTimerHandler=function(){this.timeLimit--,this.setTimeText(this.timeLimit),this.timeLimit<=0&&this.gameOver()},p.stopTimer=function(){null!=this.gameTimer&&(this.gameTimer.stop(),this.gameTimer.removeEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this))},e}(egret.Sprite);egret.registerClass(GameScene,"GameScene");var BlockUI=function(t){function e(){t.call(this),this.touchEnabled=!0}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setSkin=function(t){this.touchEnabled=!0,this.texture=RES.getRes("block"+t+"_png"),this.skinID=t},p.hide=function(){var t=this;this.touchEnabled=!1,egret.Tween.get(this).to({y:this.y-100,rotation:10,alpha:.2},300,egret.Ease.quadOut).call(function(){t.parent&&t.parent.removeChild(t),ObjectPool.getPool(e.NAME).returnObject(t),t.rotation=0,t.alpha=1})},p.hideImmediately=function(){egret.Tween.removeTweens(this),this.touchEnabled=!1,this.parent&&this.parent.removeChild(this),this.rotation=0,this.alpha=1},e.NAME="BlockUI",e}(egret.Bitmap);egret.registerClass(BlockUI,"BlockUI");var BoomUI=function(t){function e(){t.call(this),this.texture=RES.getRes("cloud_png"),this.anchorOffsetX=this.width/2,this.anchorOffsetY=this.height/2}__extends(e,t);var i=(__define,e);return p=i.prototype,p.play=function(t){this.x=t.x+this.width/2,this.y=t.y+this.height/2,t.parent.addChild(this);var i=this;egret.Tween.get(this).to({alpha:.3,rotation:360},500).call(function(){i.parent.removeChild(i),i.alpha=1,i.rotation=0,ObjectPool.getPool(e.NAME).returnObject(i)})},e.NAME="BoomUI",e}(egret.Bitmap);egret.registerClass(BoomUI,"BoomUI");var ResultPanel=function(t){function e(){t.call(this),this.bg=new egret.Bitmap(RES.getRes("resultbg_png")),this.addChild(this.bg),this.fxBtn=new SimpleButton("resultbtn_png"),this.fxBtn.setText("分享立减"),this.fxBtn.setTextSize(20),this.fxBtn.x=30,this.fxBtn.y=180,this.addChild(this.fxBtn),this.buyBtn=new SimpleButton("resultbtn_png"),this.buyBtn.setText("立刻购买"),this.buyBtn.setTextSize(20),this.buyBtn.x=180,this.buyBtn.y=180,this.addChild(this.buyBtn),this.contentText=new egret.TextField,this.contentText.width=this.bg.width,this.contentText.height=this.bg.height-this.fxBtn.height,this.contentText.textAlign=egret.HorizontalAlign.CENTER,this.contentText.verticalAlign=egret.VerticalAlign.MIDDLE,this.contentText.text="",this.contentText.textColor=0,this.addChild(this.contentText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.show=function(t){t.addChild(this),this.x=(GameConst.stage.stageWidth-this.bg.width)/2,this.y=(GameConst.stage.stageHeight-this.bg.height)/2,this.fxBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onFxBtnTouch,this),this.buyBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBuyBtnTouch,this)},p.onFxBtnTouch=function(){window.share()},p.onBuyBtnTouch=function(){window.toBuy()},p.setText=function(t){this.contentText.text=t},p.hide=function(){this.parent&&this.parent.removeChild(this)},e}(egret.Sprite);egret.registerClass(ResultPanel,"ResultPanel");var ScoreBarUI=function(t){function e(){t.call(this),this.zheScore=[],this.zheList=[],this.zheUIList=[],this.curZhe=0,this.zheScore=GameConst.zheScore,this.zheList=GameConst.zheList,this.scoreBg=new egret.Bitmap(RES.getRes("scorebg_png")),this.addChild(this.scoreBg),this.scoreBar=new egret.Bitmap(RES.getRes("scorebar_png")),this.scoreBar.x=this.scoreBg.x+1,this.scoreBar.y=this.scoreBg.y+1,this.addChild(this.scoreBar),this.scoreText=new egret.TextField,this.scoreText.width=70,this.scoreText.height=this.scoreBar.height,this.scoreText.textAlign=egret.HorizontalAlign.CENTER,this.scoreText.verticalAlign=egret.VerticalAlign.MIDDLE,this.scoreText.x=this.scoreBar.x,this.scoreText.y=this.scoreBar.y,this.addChild(this.scoreText);for(var e=this.zheList.length,i=0;e>i;i++){var s=new ZheUI;s.setText(this.zheList[i]+"折"),s.anchorOffsetX=s.width/2,s.x=this.scoreBg.x+this.zheScore[i]/GameConst.totalScore*this.scoreBar.width,s.y=this.scoreBg.y+this.scoreBg.height,s.setZhe(!1),this.addChild(s),this.zheUIList.push(s)}this.setScore(0)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setScore=function(t){this.scoreText.text=t.toString();var e=t/GameConst.totalScore;e>1&&(e=1),this.scoreBar.scaleX=e;for(var i=this.zheScore.length,s=-1,h=0;i>h;h++)t>=this.zheScore[h]&&(s=h,this.curZhe=this.zheList[s]);if(-1!=s){for(h=0;i>h;h++)this.zheUIList[h].setZhe(!1);this.zheUIList[s].setZhe(!0)}},e}(egret.DisplayObjectContainer);egret.registerClass(ScoreBarUI,"ScoreBarUI");var SelectUI=function(t){function e(){t.call(this),this.timer=new egret.Timer(300),this.selectMini=new egret.Bitmap(RES.getRes("select0_png")),this.selectBig=new egret.Bitmap(RES.getRes("select1_png")),this.addChild(this.selectMini),this.addChild(this.selectBig),this.timer.addEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.play=function(t){this.x=t.x-15,this.y=t.y-15,t.parent.addChild(this),this.timer.reset(),this.timer.start(),this.selectMini.visible=!0,this.selectBig.visible=!1},p.hide=function(){this.parent&&this.parent.removeChild(this),this.timer.stop(),this.selectMini.visible=!0,this.selectBig.visible=!1},p.onTimerHandler=function(){this.timer.currentCount%2==0?(this.selectMini.visible=!0,this.selectBig.visible=!1):(this.selectMini.visible=!1,this.selectBig.visible=!0)},e}(egret.Sprite);egret.registerClass(SelectUI,"SelectUI");var ZheUI=function(t){function e(){t.call(this),this.zhe0=new egret.Bitmap(RES.getRes("zhe0_png")),this.addChild(this.zhe0),this.zhe1=new egret.Bitmap(RES.getRes("zhe1_png")),this.addChild(this.zhe1),this.displayText=new egret.TextField,this.displayText.width=this.zhe0.width,this.displayText.height=this.zhe0.height,this.displayText.size=18,this.displayText.textColor=0,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.addChild(this.displayText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setZhe=function(t){this.zhe0.visible=!t,this.zhe1.visible=t},p.setText=function(t){this.displayText.text=t},e}(egret.Sprite);egret.registerClass(ZheUI,"ZheUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.onAddToStage=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/"),this.loadText=new egret.TextField,this.loadText.textAlign=egret.HorizontalAlign.CENTER,this.loadText.width=100,this.loadText.x=this.stage.stageWidth/2-this.loadText.width/2,this.loadText.y=this.stage.stageHeight/2,this.loadText.textColor=0,this.addChild(this.loadText),GameConst.stage=this.stage},p.onConfigComplete=function(){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.loadGroupComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.loadGroupProgress,this),RES.loadGroup("preload")},p.loadGroupProgress=function(t){this.loadText.text=t.itemsLoaded+"/"+t.itemsTotal},p.loadGroupComplete=function(){RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.loadGroupComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.loadGroupProgress,this),this.removeChild(this.loadText);var t=new GameScene;t.show()},e}(egret.Sprite);egret.registerClass(Main,"Main");