var ObjectPool=function(){function t(t){this.className=t,this.list=[]}var e=(__define,t);return p=e.prototype,p.getObject=function(){if(this.list.length>0)return this.list.shift();var t=egret.getDefinitionByName(this.className);return new t},p.returnObject=function(t){this.list.push(t)},t.getPool=function(e,i){if(void 0===i&&(i=0),!t.pool[e]&&(t.pool[e]=new t(e),0!=i))for(var s=egret.getDefinitionByName(e),h=t.pool[e],n=0;i>n;n++)h.returnObject(new s);return t.pool[e]},t.pool={},t}();egret.registerClass(ObjectPool,"ObjectPool");var GameConst=function(){function t(){}var e=(__define,t);return p=e.prototype,t.goldScore=10,t}();egret.registerClass(GameConst,"GameConst");var DiscountUI=function(t){function e(){t.call(this),this.zhe0=new egret.Bitmap(RES.getRes("zhe0_png")),this.addChild(this.zhe0),this.zhe1=new egret.Bitmap(RES.getRes("zhe1_png")),this.addChild(this.zhe1),this.displayText=new egret.TextField,this.displayText.width=this.zhe0.width,this.displayText.height=this.zhe0.height,this.displayText.size=18,this.displayText.textColor=0,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.addChild(this.displayText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setZhe=function(t){this.zhe0.visible=!t,this.zhe1.visible=t},p.setText=function(t){this.displayText.text=t},e}(egret.Sprite);egret.registerClass(DiscountUI,"DiscountUI");var GameScene=function(t){function e(){t.call(this),this.player=new Player,this.goldPool=ObjectPool.getPool(Gold.NAME,10),this.boomPool=ObjectPool.getPool(Boom.NAME,3),this.itemList=[],this.gameTimer=new egret.Timer(1e3),this.refreshTime=20,this.dropSpeed=5,this.boomRate=.2,this.itemCount=0,this.initConfig(),this.initView()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.initConfig=function(){var t=RES.getRes("config_json");GameConst.scoreList=t.scoreList,GameConst.discountList=t.discountList,GameConst.scoreMax=t.scoreList[t.scoreList.length-1],GameConst.timeLimit=t.timeLimit,GameConst.playerSpeed=t.playerSpeed,this.boomRate=t.boomRate/100,this.dropSpeed=t.dropSpeed,this.refreshTime=Math.floor(t.refreshTime/1e3*60)},p.initView=function(){this.mStage=GameConst.stage,this.gameBg=new egret.Bitmap(RES.getRes("gamebg_jpg")),this.addChild(this.gameBg),this.scoreBarUI=new ScoreBarUI,this.scoreBarUI.x=(this.mStage.stageWidth-this.scoreBarUI.scoreBg.width)/2,this.scoreBarUI.y=this.mStage.stageHeight/10,this.addChild(this.scoreBarUI),this.timerUI=new TimerUI,this.timerUI.x=(this.mStage.stageWidth-this.timerUI.width)/2,this.timerUI.y=this.mStage.stageHeight/50,this.addChild(this.timerUI),this.lifeUI=new LifeUI,this.lifeUI.x=10,this.lifeUI.y=this.timerUI.y,this.addChild(this.lifeUI),this.resultPanel=new ResultPanel,this.startBtn=new egret.Bitmap(RES.getRes("start_png")),this.startBtn.x=(this.mStage.stageWidth-this.startBtn.width)/2,this.startBtn.y=(this.mStage.stageHeight-this.startBtn.height)/2,this.startBtn.touchEnabled=!0,this.addChild(this.startBtn),this.player.anchorOffsetX=this.player.width/2,this.player.x=this.mStage.stageWidth/2,this.player.y=this.mStage.stageHeight-this.player.height,this.player.speed=GameConst.playerSpeed,this.startBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.startGame,this)},p.startGame=function(){this.startBtn.parent&&this.removeChild(this.startBtn),this.startTimer(),this.resetGame(),this.mStage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this)},p.resetGame=function(){this.player.x=this.mStage.stageWidth/2,this.player.y=this.mStage.stageHeight-this.player.height,this.addChild(this.player),this.score=0,this.timeLimit=GameConst.timeLimit,this.life=3,this.targetX=this.player.x,this.scoreBarUI.setScore(0),this.scoreBarUI.curDiscount=0,this.timerUI.setTimeText(0),this.lifeUI.setLife(this.life)},p.gameOver=function(){this.mStage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.removeEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),this.stopTimer(),this.showResult()},p.onTouchMove=function(t){this.targetX=t.stageX},p.onEnterFrame=function(){this.movePlayer(),this.createItem(),this.moveItem()},p.movePlayer=function(){Math.abs(this.targetX-this.player.x)<this.player.speed?this.player.x=this.targetX:this.targetX>this.player.x?this.player.x+=this.player.speed:this.player.x-=this.player.speed},p.moveItem=function(){for(var t=this.itemList.length,e=t-1;e>=0;e--){var i=this.itemList[e];i.y+=this.dropSpeed;var s=i.x-this.player.width/2+20,h=i.x+i.width+this.player.width/2-20,n=i.y+i.height-20,r=i.y-this.player.height+10;if(this.player.x>s&&this.player.x<h&&this.player.y>r&&this.player.y<n){if(this.removeItem(i),this.itemList.splice(e,1),i instanceof Gold)this.score+=GameConst.goldScore,this.scoreBarUI.setScore(this.score);else if(this.life-=1,this.lifeUI.setLife(this.life),this.life<=0)return void this.gameOver()}else i.y>=this.mStage.stageHeight&&(this.removeItem(i),this.itemList.splice(e,1))}},p.removeItem=function(t){t instanceof Gold?this.goldPool.returnObject(t):this.boomPool.returnObject(t),this.removeChild(t)},p.createItem=function(){if(this.itemCount++,this.itemCount>this.refreshTime){this.itemCount=0;var t,e=Math.random();t=e>this.boomRate?this.goldPool.getObject():this.boomPool.getObject(),t.x=Math.random()*(this.mStage.stageWidth-t.width),t.y=-t.height,this.addChild(t),this.itemList.push(t)}},p.startTimer=function(){this.gameTimer.addEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.gameTimer.reset(),this.gameTimer.start()},p.onTimerHandler=function(){this.timeLimit--,this.timerUI.setTimeText(this.timeLimit),this.timeLimit<=0&&this.gameOver()},p.stopTimer=function(){this.gameTimer.removeEventListener(egret.TimerEvent.TIMER,this.onTimerHandler,this),this.gameTimer.stop()},p.showResult=function(){this.resultPanel.show();var t=this.scoreBarUI.curDiscount,e="";0>=t?e+="很遗憾，未获得折扣":(e+="获得:"+t+"折",e+="\n￥1000   -￥"+Math.round(1e3*(1-t/10))),e+="\n获得天天币:100",this.resultPanel.setText(e)},e}(egret.DisplayObjectContainer);egret.registerClass(GameScene,"GameScene");var Boom=function(t){function e(){t.call(this,RES.getRes("boom_png"))}__extends(e,t);var i=(__define,e);return p=i.prototype,e.NAME="Boom",e}(egret.Bitmap);egret.registerClass(Boom,"Boom");var Gold=function(t){function e(){t.call(this,RES.getRes("gold_png"))}__extends(e,t);var i=(__define,e);return p=i.prototype,e.NAME="Gold",e}(egret.Bitmap);egret.registerClass(Gold,"Gold");var LifeUI=function(t){function e(){t.call(this),this.lifeList=[];for(var e=0;3>e;e++){var i=new egret.Bitmap(RES.getRes("life_png"));i.x=e*(10+i.width),this.addChild(i),this.lifeList.push(i)}}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setLife=function(t){for(var e=0;3>e;e++)this.lifeList[e].visible=t>e?!0:!1},e}(egret.DisplayObjectContainer);egret.registerClass(LifeUI,"LifeUI");var LoadUI=function(t){function e(){t.call(this),this.loadText=new egret.TextField,this.loadText.textAlign=egret.HorizontalAlign.CENTER,this.loadText.width=100,this.loadText.textColor=0,this.addChild(this.loadText),this.x=GameConst.stage.stageWidth/2-this.loadText.width/2,this.y=GameConst.stage.stageHeight/2}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setLoadText=function(t){this.loadText.text=t},e}(egret.DisplayObjectContainer);egret.registerClass(LoadUI,"LoadUI");var Player=function(t){function e(){t.call(this),this.bm0=new egret.Bitmap(RES.getRes("player0_png")),this.bm1=new egret.Bitmap(RES.getRes("player1_png")),this.addChild(this.bm0),this.addChild(this.bm1),this.bm1.visible=!1}__extends(e,t);var i=(__define,e);return p=i.prototype,p.eat=function(){this.bm0.visible=!1,this.bm1.visible=!0;var t=this;egret.Tween.get(this).wait(100).call(function(){t.bm0.visible=!0,t.bm1.visible=!1})},e}(egret.DisplayObjectContainer);egret.registerClass(Player,"Player");var ResultPanel=function(t){function e(){t.call(this),this.bg=new egret.Bitmap(RES.getRes("resultbg_png")),this.addChild(this.bg),this.fxBtn=new SimpleButton("resultbtn_png"),this.fxBtn.setText("分享立减"),this.fxBtn.setTextSize(20),this.fxBtn.x=30,this.fxBtn.y=180,this.addChild(this.fxBtn),this.buyBtn=new SimpleButton("resultbtn_png"),this.buyBtn.setText("立刻购买"),this.buyBtn.setTextSize(20),this.buyBtn.x=180,this.buyBtn.y=180,this.addChild(this.buyBtn),this.contentText=new egret.TextField,this.contentText.width=this.bg.width,this.contentText.height=this.bg.height-this.fxBtn.height,this.contentText.textAlign=egret.HorizontalAlign.CENTER,this.contentText.verticalAlign=egret.VerticalAlign.MIDDLE,this.contentText.text="",this.contentText.textColor=0,this.addChild(this.contentText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.show=function(){GameConst.stage.addChild(this),this.x=(GameConst.stage.stageWidth-this.bg.width)/2,this.y=(GameConst.stage.stageHeight-this.bg.height)/2,this.fxBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onFxBtnTouch,this),this.buyBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBuyBtnTouch,this)},p.onFxBtnTouch=function(){window.share()},p.onBuyBtnTouch=function(){window.toBuy()},p.setText=function(t){this.contentText.text=t},p.hide=function(){this.parent&&this.parent.removeChild(this)},e}(egret.Sprite);egret.registerClass(ResultPanel,"ResultPanel");var ScoreBarUI=function(t){function e(){t.call(this),this.discountUIList=[],this.curDiscount=0,this.scoreBg=new egret.Bitmap(RES.getRes("scorebg_png")),this.addChild(this.scoreBg),this.scoreBar=new egret.Bitmap(RES.getRes("scorebar_png")),this.scoreBar.x=this.scoreBg.x+1,this.scoreBar.y=this.scoreBg.y+1,this.addChild(this.scoreBar),this.scoreText=new egret.TextField,this.scoreText.width=70,this.scoreText.height=this.scoreBar.height,this.scoreText.textAlign=egret.HorizontalAlign.CENTER,this.scoreText.verticalAlign=egret.VerticalAlign.MIDDLE,this.scoreText.x=this.scoreBar.x,this.scoreText.y=this.scoreBar.y,this.addChild(this.scoreText);for(var e=GameConst.scoreList,i=GameConst.discountList,s=i.length,h=0;s>h;h++){var n=new DiscountUI;n.setText(i[h]+"折"),n.anchorOffsetX=n.width/2,n.x=this.scoreBg.x+e[h]/GameConst.scoreMax*this.scoreBar.width,n.y=this.scoreBg.y+this.scoreBg.height,n.setZhe(!1),this.addChild(n),this.discountUIList.push(n)}this.setScore(0)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setScore=function(t){this.scoreText.text=t.toString();var e=t/GameConst.scoreMax;e>1&&(e=1),this.scoreBar.scaleX=e;for(var i=GameConst.scoreList,s=i.length,h=-1,n=0;s>n;n++)t>=i[n]&&(h=n,this.curDiscount=GameConst.discountList[h]);if(-1!=h){for(n=0;s>n;n++)this.discountUIList[n].setZhe(!1);this.discountUIList[h].setZhe(!0)}},e}(egret.DisplayObjectContainer);egret.registerClass(ScoreBarUI,"ScoreBarUI");var SimpleButton=function(t){function e(e,i){void 0===i&&(i=null),t.call(this),this.up=new egret.Bitmap(RES.getRes(e)),this.addChild(this.up),null!=i&&(this.down=new egret.Bitmap(RES.getRes(i)),this.addChild(this.down),this.down.visible=!1),this.touchEnabled=!0,this.touchChildren=!1,this.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.touchBegin,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.touchBegin=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onPress()},p.touchEnd=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.touchEnd,this),this.onRelease()},p.onPress=function(){this.down&&(this.up.visible=!1,this.down&&(this.down.visible=!0))},p.onRelease=function(){this.down&&(this.up.visible=!0,this.down&&(this.down.visible=!1))},p.setText=function(t){null==this.displayText&&null!=this.up&&(this.displayText=new egret.TextField,this.displayText.width=this.up.width,this.displayText.height=this.up.height,this.displayText.textAlign=egret.HorizontalAlign.CENTER,this.displayText.verticalAlign=egret.VerticalAlign.MIDDLE,this.displayText.textColor=0,this.addChild(this.displayText)),this.displayText.text=t},p.setTextColor=function(t){this.displayText&&(this.displayText.textColor=t)},p.setTextSize=function(t){this.displayText&&(this.displayText.size=t)},e}(egret.Sprite);egret.registerClass(SimpleButton,"SimpleButton");var TimerUI=function(t){function e(){t.call(this),this.timeBg=new egret.Bitmap(RES.getRes("timebg_png")),this.addChild(this.timeBg),this.timeText=new egret.TextField,this.timeText.width=120,this.timeText.height=50,this.timeText.textAlign=egret.HorizontalAlign.CENTER,this.timeText.verticalAlign=egret.VerticalAlign.MIDDLE,this.timeText.x=this.timeBg.x+(this.timeBg.width-this.timeText.width)/2,this.timeText.y=this.timeBg.y+(this.timeBg.height-this.timeText.height)/2,this.addChild(this.timeText)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setTimeText=function(t){this.timeText.text="时间:"+t.toString()},e}(egret.DisplayObjectContainer);egret.registerClass(TimerUI,"TimerUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.onAddToStage=function(){GameConst.stage=this.stage,this.loadUI=new LoadUI,this.addChild(this.loadUI),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},p.onConfigComplete=function(){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},p.onResourceLoadComplete=function(){RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.createGameScene()},p.onResourceProgress=function(t){this.loadUI.setLoadText(t.itemsLoaded+"/"+t.itemsTotal)},p.createGameScene=function(){this.removeChild(this.loadUI);var t=new GameScene;this.addChild(t)},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");